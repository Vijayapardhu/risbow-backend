name: PR Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, master, develop]

concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
            ci
          scopes: |
            backend
            api
            database
            auth
            orders
            payments
            inventory
            delivery
            search
            recommendations
          requireScope: false
          subjectPattern: ^(?![A-Z]).+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            must not start with an uppercase character.

      - name: Validate Prisma schema
        run: npx prisma validate
        env:
          DATABASE_URL: postgresql://user:password@localhost:5432/test?schema=public

      - name: Type check
        run: npm run build --if-present || npx tsc --noEmit

      - name: Run tests
        run: npm test -- --passWithNoTests
        env:
          NODE_ENV: test
          DATABASE_URL: postgresql://user:password@localhost:5432/test?schema=public
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-key

      - name: Check for TODO/FIXME comments
        run: |
          if grep -r "TODO\|FIXME" --include="*.ts" --include="*.js" src/; then
            echo "⚠️ Found TODO/FIXME comments. Please address them or document why they're acceptable."
            exit 0  # Warning only, don't fail PR
          fi

      - name: Check for console.log statements
        run: |
          if grep -r "console\.log" --include="*.ts" --exclude-dir=*.spec.ts src/; then
            echo "⚠️ Found console.log statements. Consider using the Logger service instead."
            exit 0  # Warning only
          fi

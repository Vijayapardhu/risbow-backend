// ============================================
// ENTERPRISE PRODUCT MANAGEMENT SYSTEM
// ============================================

// --- Brands & Categories ---

model Brand {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String    @unique
  logo        String?
  description String?
  website     String?
  isActive    Boolean   @default(true)
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([slug])
  @@index([isActive])
}

model Category {
  id           String     @id @default(cuid())
  name         String
  slug         String     @unique
  parentId     String?
  description  String?
  image        String?
  icon         String?
  displayOrder Int        @default(0)
  isActive     Boolean    @default(true)
  parent       Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children     Category[] @relation("CategoryHierarchy")
  products     Product[]
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  @@index([parentId])
  @@index([slug])
  @@index([isActive])
}

// --- Core Product System ---

model Product {
  id              String            @id @default(cuid())
  title           String
  description     String?           @db.Text
  brandId         String?
  categoryId      String?
  baseSku         String            @unique
  barcode         String?
  status          ProductStatus     @default(DRAFT)
  isFeatured      Boolean           @default(false)
  createdBy       String
  
  // Relations
  brand           Brand?            @relation(fields: [brandId], references: [id])
  category        Category?         @relation(fields: [categoryId], references: [id])
  creator         User              @relation("ProductCreator", fields: [createdBy], references: [id])
  variants        ProductVariant[]
  images          ProductImage[]
  vendorOffers    VendorProductOffer[]
  reviews         ProductReview[]
  questions       ProductQuestion[]
  seo             ProductSEO?
  analytics       ProductAnalytics[]
  relatedFrom     RelatedProduct[]  @relation("ProductRelations")
  relatedTo       RelatedProduct[]  @relation("RelatedProducts")
  bundleItems     BundleItem[]
  dealProducts    FlashDealProduct[]
  activityLogs    ProductActivityLog[]
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([categoryId])
  @@index([brandId])
  @@index([status])
  @@index([isFeatured])
  @@index([createdBy])
  @@fulltext([title, description])
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
  OUT_OF_STOCK
}

model ProductVariant {
  id                String                @id @default(cuid())
  productId         String
  sku               String                @unique
  variantName       String?
  attributes        Json?                 // {"color": "Red", "size": "L"}
  price             Decimal               @db.Decimal(10, 2)
  compareAtPrice    Decimal?              @db.Decimal(10, 2)
  costPrice         Decimal?              @db.Decimal(10, 2)
  weight            Decimal?              @db.Decimal(8, 2)
  dimensions        Json?                 // {"length": 10, "width": 5, "height": 3}
  image             String?
  isActive          Boolean               @default(true)
  
  product           Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendorOffers      VendorProductOffer[]
  inventory         Inventory[]
  analytics         ProductAnalytics[]
  
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  
  @@index([productId])
  @@index([sku])
  @@index([isActive])
}

model ProductAttribute {
  id            String   @id @default(cuid())
  name          String   @unique
  displayName   String
  type          String   @default("dropdown") // dropdown, swatch, text, number
  values        Json     // ["S", "M", "L", "XL"]
  isRequired    Boolean  @default(false)
  displayOrder  Int      @default(0)
  createdAt     DateTime @default(now())
  
  @@index([name])
}

model ProductImage {
  id           String   @id @default(cuid())
  productId    String
  variantId    String?
  imageUrl     String
  thumbnailUrl String?
  altText      String?
  displayOrder Int      @default(0)
  isPrimary    Boolean  @default(false)
  
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  
  @@index([productId, displayOrder])
  @@index([variantId])
}

// --- Multi-Vendor System ---

model VendorProductOffer {
  id            String         @id @default(cuid())
  productId     String
  variantId     String?
  vendorId      String
  sellerSku     String?
  price         Decimal        @db.Decimal(10, 2)
  stockQuantity Int            @default(0)
  shippingCost  Decimal        @db.Decimal(10, 2) @default(0)
  deliveryDays  Int            @default(3)
  isActive      Boolean        @default(true)
  isApproved    Boolean        @default(false)
  approvedBy    String?
  approvedAt    DateTime?
  
  product       Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant       ProductVariant? @relation(fields: [variantId], references: [id])
  vendor        Vendor         @relation(fields: [vendorId], references: [id])
  approver      User?          @relation("OfferApprover", fields: [approvedBy], references: [id])
  stats         VendorProductStats?
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  @@unique([productId, variantId, vendorId])
  @@index([productId])
  @@index([vendorId])
  @@index([isActive, isApproved])
}

model VendorProductStats {
  offerId      String              @id
  unitsSold    Int                 @default(0)
  revenue      Decimal             @db.Decimal(12, 2) @default(0)
  avgRating    Decimal?            @db.Decimal(3, 2)
  totalReviews Int                 @default(0)
  returnRate   Decimal             @db.Decimal(5, 2) @default(0)
  lastSaleAt   DateTime?
  
  offer        VendorProductOffer  @relation(fields: [offerId], references: [id], onDelete: Cascade)
  updatedAt    DateTime            @updatedAt
}

// --- Inventory Management ---

model InventoryLocation {
  id        String      @id @default(cuid())
  name      String
  type      String      @default("warehouse") // warehouse, vendor_store, dropship
  vendorId  String?
  address   String?
  city      String?
  state     String?
  country   String?
  postalCode String?
  isActive  Boolean     @default(true)
  
  vendor    Vendor?     @relation(fields: [vendorId], references: [id])
  inventory Inventory[]
  
  createdAt DateTime    @default(now())
  
  @@index([vendorId])
  @@index([type])
}

model Inventory {
  id                String             @id @default(cuid())
  productId         String
  variantId         String?
  locationId        String
  quantityAvailable Int                @default(0)
  quantityReserved  Int                @default(0)
  quantityIncoming  Int                @default(0)
  reorderPoint      Int                @default(10)
  reorderQuantity   Int                @default(50)
  lastRestockedAt   DateTime?
  
  variant           ProductVariant?    @relation(fields: [variantId], references: [id])
  location          InventoryLocation  @relation(fields: [locationId], references: [id])
  movements         InventoryMovement[]
  
  updatedAt         DateTime           @updatedAt
  
  @@unique([variantId, locationId])
  @@index([variantId])
  @@index([locationId])
  @@index([quantityAvailable])
}

model InventoryMovement {
  id            String    @id @default(cuid())
  inventoryId   String
  movementType  String    // restock, sale, return, adjustment, transfer
  quantity      Int
  referenceType String?   // order, purchase_order, manual
  referenceId   String?
  notes         String?
  createdBy     String
  
  inventory     Inventory @relation(fields: [inventoryId], references: [id])
  creator       User      @relation("InventoryMovements", fields: [createdBy], references: [id])
  
  createdAt     DateTime  @default(now())
  
  @@index([inventoryId, createdAt])
  @@index([referenceType, referenceId])
}

// --- Product Analytics ---

model ProductAnalytics {
  id             String          @id @default(cuid())
  productId      String
  variantId      String?
  date           DateTime        @db.Date
  pageViews      Int             @default(0)
  uniqueVisitors Int             @default(0)
  addToCart      Int             @default(0)
  purchases      Int             @default(0)
  revenue        Decimal         @db.Decimal(12, 2) @default(0)
  avgTimeOnPage  Int?            // seconds
  bounceRate     Decimal?        @db.Decimal(5, 2)
  
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant        ProductVariant? @relation(fields: [variantId], references: [id])
  
  @@unique([productId, variantId, date])
  @@index([productId, date])
  @@index([purchases, revenue])
}

// --- SEO & Metadata ---

model ProductSEO {
  productId       String   @id
  urlSlug         String   @unique
  metaTitle       String?  @db.VarChar(60)
  metaDescription String?  @db.VarChar(160)
  keywords        String[]
  ogTitle         String?
  ogDescription   String?
  ogImage         String?
  schemaMarkup    Json?
  canonicalUrl    String?
  robotsMeta      String   @default("index,follow")
  
  product         Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  updatedAt       DateTime @updatedAt
  
  @@index([urlSlug])
}

// --- Reviews & Ratings ---

model ProductReview {
  id                String    @id @default(cuid())
  productId         String
  variantId         String?
  userId            String
  orderId           String?
  rating            Int       // 1-5
  title             String?
  comment           String?   @db.Text
  verifiedPurchase  Boolean   @default(false)
  status            String    @default("pending") // pending, approved, rejected, flagged
  helpfulCount      Int       @default(0)
  notHelpfulCount   Int       @default(0)
  vendorResponse    String?   @db.Text
  vendorRespondedAt DateTime?
  
  product           Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id])
  moderation        ReviewModeration?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([productId, status])
  @@index([userId])
  @@index([status])
}

model ReviewModeration {
  reviewId         String   @id
  moderatedBy      String
  action           String   // approved, rejected, flagged
  reason           String?
  autoModerated    Boolean  @default(false)
  moderationScore  Decimal? @db.Decimal(3, 2)
  
  review           ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  moderator        User          @relation("ReviewModerator", fields: [moderatedBy], references: [id])
  
  moderatedAt      DateTime @default(now())
}

model ProductQuestion {
  id        String           @id @default(cuid())
  productId String
  userId    String
  question  String           @db.Text
  status    String           @default("unanswered") // unanswered, answered, hidden
  views     Int              @default(0)
  
  product   Product          @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User             @relation("ProductQuestions", fields: [userId], references: [id])
  answers   ProductAnswer[]
  
  createdAt DateTime         @default(now())
  
  @@index([productId, status])
}

model ProductAnswer {
  id               String          @id @default(cuid())
  questionId       String
  userId           String
  answer           String          @db.Text
  isSellerResponse Boolean         @default(false)
  isVerified       Boolean         @default(false)
  helpfulCount     Int             @default(0)
  
  question         ProductQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user             User            @relation("ProductAnswers", fields: [userId], references: [id])
  
  createdAt        DateTime        @default(now())
  
  @@index([questionId])
}

// --- Marketing & Promotions ---

model FlashDeal {
  id            String             @id @default(cuid())
  name          String
  description   String?            @db.Text
  startDate     DateTime
  endDate       DateTime
  discountType  String             // percentage, fixed_amount
  discountValue Decimal            @db.Decimal(10, 2)
  maxDiscount   Decimal?           @db.Decimal(10, 2)
  isActive      Boolean            @default(true)
  createdBy     String
  
  creator       User               @relation("DealCreator", fields: [createdBy], references: [id])
  products      FlashDealProduct[]
  
  createdAt     DateTime           @default(now())
  
  @@index([isActive, startDate, endDate])
}

model FlashDealProduct {
  dealId     String   @id @default(cuid())
  productId  String
  variantId  String?
  dealPrice  Decimal  @db.Decimal(10, 2)
  stockLimit Int?
  soldCount  Int      @default(0)
  
  deal       FlashDeal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  product    Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([dealId, productId, variantId])
  @@index([dealId])
}

model ProductBundle {
  id            String       @id @default(cuid())
  name          String
  description   String?      @db.Text
  bundleSku     String       @unique
  bundlePrice   Decimal      @db.Decimal(10, 2)
  savingsAmount Decimal      @db.Decimal(10, 2)
  isActive      Boolean      @default(true)
  startDate     DateTime?
  endDate       DateTime?
  
  items         BundleItem[]
  
  createdAt     DateTime     @default(now())
}

model BundleItem {
  bundleId     String        @id @default(cuid())
  productId    String
  variantId    String?
  quantity     Int           @default(1)
  displayOrder Int           @default(0)
  
  bundle       ProductBundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product      Product       @relation(fields: [productId], references: [id])
  
  @@unique([bundleId, productId, variantId])
}

model RelatedProduct {
  productId        String  @id @default(cuid())
  relatedProductId String
  relationType     String  @default("similar") // similar, complementary, alternative
  displayOrder     Int     @default(0)
  autoGenerated    Boolean @default(false)
  
  product          Product @relation("ProductRelations", fields: [productId], references: [id], onDelete: Cascade)
  relatedProduct   Product @relation("RelatedProducts", fields: [relatedProductId], references: [id], onDelete: Cascade)
  
  @@unique([productId, relatedProductId])
  @@index([productId, displayOrder])
}

// --- Activity Logging ---

model ProductActivityLog {
  id         String   @id @default(cuid())
  productId  String
  userId     String
  actionType String   // created, updated, deleted, price_changed, etc.
  entityType String   // product, variant, inventory, seo, review
  entityId   String?
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?  @db.Text
  
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user       User     @relation("ProductLogs", fields: [userId], references: [id])
  
  createdAt  DateTime @default(now())
  
  @@index([productId, createdAt])
  @@index([userId, createdAt])
  @@index([actionType, createdAt])
}

// --- Update User model with new relations ---
// Add these to existing User model:
// products          Product[]             @relation("ProductCreator")
// vendorOffers      VendorProductOffer[]  @relation("OfferApprover")
// inventoryMovements InventoryMovement[]  @relation("InventoryMovements")
// reviews           ProductReview[]
// reviewModerations ReviewModeration[]    @relation("ReviewModerator")
// productQuestions  ProductQuestion[]     @relation("ProductQuestions")
// productAnswers    ProductAnswer[]       @relation("ProductAnswers")
// flashDeals        FlashDeal[]           @relation("DealCreator")
// productLogs       ProductActivityLog[]  @relation("ProductLogs")

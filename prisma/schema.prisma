generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model ProductSearchMiss {
  id                 String    @id @default(cuid())
  query              String
  userId             String?
  count              Int       @default(1)
  lastSearchedAt     DateTime  @updatedAt
  firstSearchedAt    DateTime  @default(now())
  inferredCategoryId String?
  keywords           String[]
  metadata           Json?
  normalizedQuery    String
  resolved           Boolean   @default(false)
  resolvedProductId  String?
  region             String?
  category           Category? @relation(fields: [inferredCategoryId], references: [id])
  user               User?     @relation(fields: [userId], references: [id])

  @@index([normalizedQuery])
  @@index([count])
  @@index([resolved])
  @@index([lastSearchedAt])
  @@index([region])
}

model SearchTrending {
  id       String   @id @default(cuid())
  query    String
  region   String?  @default("global")
  count    Int      @default(1)
  lastSeen DateTime @default(now())

  @@unique([query, region])
  @@index([region, count])
  @@index([lastSeen])
}

model CartInsight {
  id              String          @id @default(cuid())
  userId          String
  cartValue       Int
  itemCount       Int
  categories      String[]
  cartPattern     String
  hesitationScore Float
  abandonRisk     Float
  resolvedAt      DateTime?
  severity        InsightSeverity
  triggeredAt     DateTime        @default(now())
  type            CartInsightType
  user            User            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([cartPattern])
  @@index([triggeredAt])
  @@index([type])
  @@index([severity])
}

model RecommendationEvent {
  id              String   @id @default(cuid())
  userId          String
  source          String
  strategy        String
  productIds      String[]
  accepted        Boolean?
  cartValueBefore Int
  cartValueAfter  Int?
  createdAt       DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])

  @@index([strategy])
  @@index([accepted])
}

model UserProductEvent {
  id        String               @id @default(cuid())
  userId    String?
  sessionId String?
  type      UserProductEventType
  source    String?
  productId String
  variantId String?
  quantity  Int?
  price     Int?
  metadata  Json?
  createdAt DateTime             @default(now())
  product   Product              @relation(fields: [productId], references: [id])
  user      User?                @relation(fields: [userId], references: [id])

  @@index([userId, createdAt])
  @@index([productId, createdAt])
  @@index([type, createdAt])
  @@index([source, createdAt])
}

model BowActionLog {
  id                String        @id @default(cuid())
  userId            String
  actionType        BowActionType
  productId         String?
  variantId         String?
  quantity          Int?
  price             Int?
  reason            String
  guardrailCheck    Json?
  autoReversed      Boolean       @default(false)
  reverseReason     String?
  attributedRevenue Int?
  createdAt         DateTime      @default(now())
  reversedAt        DateTime?
  product           Product?      @relation(fields: [productId], references: [id])
  user              User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([actionType])
  @@index([productId])
  @@index([createdAt])
  @@index([autoReversed])
}

model UserPreferenceProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  preferredCategories String[]
  preferredBrands     String[]
  sizePreferences     String[]
  priceSensitivity    String   @default("MEDIUM")
  colorAffinity       String[]
  styleTags           String[]
  lastUpdated         DateTime @updatedAt
  confidenceScore     Float    @default(0.1)
  user                User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([priceSensitivity])
}

model User {
  id                                                 String                   @id @default(cuid())
  mobile                                             String                   @unique
  name                                               String?
  email                                              String?                  @unique
  password                                           String?
  role                                               UserRole                 @default(CUSTOMER)
  status                                             UserStatus               @default(ACTIVE)
  coinsBalance                                       Int                      @default(0)
  referralCode                                       String                   @unique @default(cuid())
  referredBy                                         String?
  dateOfBirth                                        DateTime?
  gender                                             String?
  size                                               String?
  footwearSize                                       Int?
  stylePrefs                                         String?
  colors                                             String?
  riskTag                                            RiskTag                  @default(LOW)
  valueTag                                           ValueTag                 @default(NORMAL)
  isCodDisabled                                      Boolean                  @default(false)
  isRefundsDisabled                                  Boolean                  @default(false)
  createdAt                                          DateTime                 @default(now())
  forceLogoutAt                                      DateTime?
  kycDocuments                                       Json?
  kycStatus                                          String                   @default("NOT_SUBMITTED")
  miscDocuments                                      Json?
  updatedAt                                          DateTime                 @updatedAt
  metadata                                           Json?                    @default("{}")
  assignedLeads                                      AbandonedCheckout[]      @relation("AgentCheckouts")
  abandonedCheckouts                                 AbandonedCheckout[]
  addresses                                          Address[]
  authoredNotes                                      AdminNote[]              @relation("AdminAuthor")
  receivedNotes                                      AdminNote[]              @relation("UserNotes")
  auditLogs                                          AuditLog[]
  bets                                               Bet[]
  bowActionLogs                                      BowActionLog[]
  BowInteraction                                     BowInteraction[]
  buyLater                                           BuyLater[]
  cart                                               Cart?
  cartInsights                                       CartInsight[]
  leadFollowups                                      CheckoutFollowup[]
  coinLedger                                         CoinLedger[]
  coinValuationsSet                                  CoinValuation[]          @relation("CoinValuationSetBy")
  ledger                                             LedgerEntry[]
  notifications                                      Notification[]
  orders                                             Order[]
  paymentIntentsCreated                              PaymentIntent[]          @relation("PaymentIntentCreatedBy")
  productSearchMisses                                ProductSearchMiss[]
  recommendationEvents                               RecommendationEvent[]
  ReferralTracking_ReferralTracking_refereeIdToUser  ReferralTracking[]       @relation("ReferralTracking_refereeIdToUser")
  ReferralTracking_ReferralTracking_referrerIdToUser ReferralTracking[]       @relation("ReferralTracking_referrerIdToUser")
  ReferralRewardGrantsAsInviter                      ReferralRewardGrant[]    @relation("ReferralInviter")
  ReferralRewardGrantsAsInvitee                      ReferralRewardGrant[]    @relation("ReferralInvitee")
  checkoutGroups                                     CheckoutGroup[]
  localPromotionsSet                                 LocalPromotion[]
  referralRewardRulesSet                             ReferralRewardRule[]
  packingProofsUploaded                              OrderPackingProof[]
  reports                                            Report[]
  returns                                            ReturnRequest[]
  reviews                                            Review[]
  createdRooms                                       Room[]
  rooms                                              RoomMember[]
  telecallerPerformance                              TelecallerPerformance[]
  devices                                            UserDevice[]
  userPreferenceProfile                              UserPreferenceProfile?
  productEvents                                      UserProductEvent[]
  VendorFollower                                     VendorFollower[]
  vendorInquiriesRequested                           VendorInquiry[]          @relation("VendorInquiryRequester")
  wallet                                             Wallet?
  wishlist                                           Wishlist[]
  bannerImpressions                                  BannerImpressionLedger[]
  reelInteractions                                   ReelInteractionLedger[]
  creatorProfile                                     CreatorProfile?
  refunds                                            Refund[]               @relation("UserRefunds")
  tickets                                            SupportTicket[]        @relation("UserTickets")

  @@index([role])
  @@index([status])
  @@index([referredBy])
}

model UserDevice {
  id         String   @id @default(cuid())
  userId     String
  platform   String
  token      String   @unique
  isActive   Boolean  @default(true)
  lastSeenAt DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([lastSeenAt])
}

model Room {
  id              String        @id @default(cuid())
  name            String
  size            Int
  status          RoomStatus    @default(LOCKED)
  offerId         String        @default("")
  startAt         DateTime
  endAt           DateTime
  unlockMinOrders Int
  unlockMinValue  Int
  createdById     String?
  isSystemRoom    Boolean       @default(false)
  createdAt       DateTime      @default(now())
  memberCount     Int           @default(1)
  maxDiscount     Float?
  maxMembers      Int?
  productId       String?
  type            RoomType      @default(GOAL_BASED)
  createdBy       User?         @relation(fields: [createdById], references: [id])
  product         Product?      @relation(fields: [productId], references: [id])
  boosts          RoomBoost[]
  insights        RoomInsight[]
  members         RoomMember[]

  @@index([status, endAt])
  @@index([createdById])
  @@index([productId])
}

model RoomBoost {
  id        String        @id @default(cuid())
  roomId    String
  vendorId  String?
  type      RoomBoostType
  coinsCost Int
  startAt   DateTime
  endAt     DateTime
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  room      Room          @relation(fields: [roomId], references: [id])

  @@index([roomId])
  @@index([type, isActive])
  @@index([startAt, endAt])
}

model RoomInsight {
  id        String   @id @default(cuid())
  roomId    String
  metric    String
  value     Float
  createdAt DateTime @default(now())
  room      Room     @relation(fields: [roomId], references: [id])

  @@index([roomId])
  @@index([metric])
}

model WeeklyOffer {
  id        String   @id @default(cuid())
  name      String
  startAt   DateTime
  endAt     DateTime
  isActive  Boolean  @default(true)
  rules     Json?
  createdAt DateTime @default(now())
}

model RoomMember {
  roomId String
  userId String
  status MemberStatus @default(PENDING)
  room   Room         @relation(fields: [roomId], references: [id])
  user   User         @relation(fields: [userId], references: [id])

  @@id([roomId, userId])
  @@index([userId])
}

model Category {
  id                  String              @id @default(cuid())
  name                String
  image               String?
  nameTE              String?
  parentId            String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  attributeSchema     Json?
  isActive            Boolean             @default(true)
  parent              Category?           @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children            Category[]          @relation("CategoryHierarchy")
  commissions         CategoryCommission?
  specs               CategorySpec[]
  products            Product[]
  productSearchMisses ProductSearchMiss[]
  localPromotions     LocalPromotion[]

  @@index([parentId])
  @@index([isActive])
}

model GiftSKU {
  id                 String   @id @default(cuid())
  title              String
  stock              Int      @default(0)
  cost               Int      @default(0)
  eligibleCategories Json?
  createdAt          DateTime @default(now())
  orders             Order[]
}

model CoinLedger {
  id                String    @id @default(cuid())
  userId            String
  amount            Int
  source            String
  referenceId       String?
  expiresAt         DateTime?
  createdAt         DateTime  @default(now())
  isExpired         Boolean   @default(false)
  paisePerCoinAtTxn Int       @default(100)
  roleAtTxn         UserRole  @default(CUSTOMER)
  user              User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([isExpired])
  @@index([expiresAt])
  @@index([roleAtTxn, createdAt])
}

model Vendor {
  id                              String                      @id @default(cuid())
  name                            String
  mobile                          String                      @unique
  email                           String?
  kycStatus                       String                      @default("PENDING")
  tier                            String                      @default("BASIC")
  gstNumber                       String?
  isGstVerified                   Boolean                     @default(false)
  kycDocuments                    Json?
  skuLimit                        Int                         @default(100)
  role                            VendorRole                  @default(RETAILER)
  coinsBalance                    Int                         @default(0)
  followCount                     Int                         @default(0)
  vendorCode                      String?                     @unique
  commissionRate                  Float                       @default(0.0)
  createdAt                       DateTime                    @default(now())
  updatedAt                       DateTime                    @updatedAt
  storeStatus                     String?                     @default("ACTIVE") // ACTIVE, SUSPENDED (for shop availability)
  storeClosedUntil                DateTime? // Temporary closure
  bankDetails                     Json?
  lastPayoutDate                  DateTime?
  pendingEarnings                 Int                         @default(0)
  performanceScore                Float                       @default(0.0)
  pickupEnabled                   Boolean                     @default(false)
  pickupTimings                   Json?
  storeBanner                     String?
  storeLogo                       String?
  storeName                       String?
  storeTimings                    Json?
  commissionOverride              Decimal?                    @db.Decimal(5, 4)
  latitude                        Float?
  longitude                       Float?
  pincode                         String?
  // Auto-clearance settings
  autoClearanceThresholdDays      Int?                        @default(7) // Days before expiry to auto-add to clearance
  defaultClearanceDiscountPercent Int?                        @default(20) // Default discount % for auto-clearance (0-100)
  coupons                         Coupon[]
  orderSettlements                OrderSettlement[]
  products                        Product[]
  returns                         ReturnRequest[]
  reviews                         Review[]
  VendorFollower                  VendorFollower[]
  inquiriesReceived               VendorInquiry[]             @relation("VendorInquiryWholesaler")
  VendorMembership                VendorMembership?
  VendorPayout                    VendorPayout[]
  VendorPromotion                 VendorPromotion[]
  localPromotions                 LocalPromotion[]
  serviceAreas                    VendorServiceArea[]
  deliveryWindows                 VendorDeliveryWindow[]
  packingProofs                   OrderPackingProof[]
  pickupPoints                    PickupPoint[]
  deliverySlotSnapshots           OrderDeliverySlotSnapshot[]
  bowCoinLedger                   VendorBowCoinLedger[]
  disciplineEvents                VendorDisciplineEvent[]
  disciplineState                 VendorDisciplineState?
  stories                         Story[]
  reels                           Reel[]
  clearanceProducts               ClearanceProduct[]
  documents                       VendorDocument[]
  bannerCampaigns                 BannerCampaign[]

  @@index([kycStatus])
  @@index([tier])
  @@index([pincode])
}

model RoomPackage {
  id               String   @id @default(cuid())
  vendorId         String
  packageType      String
  remainingCredits Int
  createdAt        DateTime @default(now())
}

model Address {
  id           String     @id @default(cuid())
  userId       String
  title        String?
  name         String
  mobile       String?
  street       String?
  city         String
  state        String
  pincode      String
  isDefault    Boolean    @default(false)
  addressLine1 String     @default("")
  addressLine2 String?
  createdAt    DateTime   @default(now())
  label        String     @default("Home")
  phone        String
  updatedAt    DateTime   @updatedAt
  latitude     Float?
  longitude    Float?
  geoSource    GeoSource?
  geoUpdatedAt DateTime?
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@index([userId])
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]

  @@index([userId])
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  variantId String?
  quantity  Int
  cart      Cart    @relation(fields: [cartId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([cartId])
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, productId])
}

model VendorInquiry {
  id                 String        @id @default(cuid())
  wholesalerVendorId String
  requesterUserId    String
  productId          String
  quantity           Int
  message            String?
  status             InquiryStatus @default(PENDING)
  response           String?
  respondedAt        DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  product            Product       @relation(fields: [productId], references: [id], onDelete: Cascade)
  requester          User          @relation("VendorInquiryRequester", fields: [requesterUserId], references: [id], onDelete: Cascade)
  wholesaler         Vendor        @relation("VendorInquiryWholesaler", fields: [wholesalerVendorId], references: [id], onDelete: Cascade)

  @@index([wholesalerVendorId, status])
  @@index([requesterUserId, status])
  @@index([productId])
  @@index([createdAt])
}

model Review {
  id           String   @id @default(cuid())
  userId       String
  productId    String?
  vendorId     String?
  rating       Int
  comment      String?
  images       String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  helpfulCount Int      @default(0)
  isVerified   Boolean  @default(false)
  status       String   @default("ACTIVE")
  product      Product? @relation(fields: [productId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
  vendor       Vendor?  @relation(fields: [vendorId], references: [id])

  @@index([productId])
  @@index([vendorId])
  @@index([userId])
  @@index([productId, status])
  @@index([vendorId, status])
}

model Payment {
  id              String        @id @default(cuid())
  orderId         String        @unique
  amount          Int
  currency        String        @default("INR")
  provider        String
  providerOrderId String?
  paymentId       String?
  status          PaymentStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  order           Order         @relation(fields: [orderId], references: [id])
}

model PaymentIntent {
  id              String               @id @default(cuid())
  purpose         PaymentIntentPurpose
  referenceId     String
  amount          Int
  currency        String               @default("INR")
  provider        String               @default("RAZORPAY")
  providerOrderId String?
  paymentId       String?
  status          PaymentStatus        @default(PENDING)
  metadata        Json?
  createdByUserId String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  createdByUser   User?                @relation("PaymentIntentCreatedBy", fields: [createdByUserId], references: [id])

  @@unique([purpose, referenceId])
  @@index([status, createdAt])
  @@index([purpose, createdAt])
  @@index([createdByUserId, createdAt])
  @@index([providerOrderId])
}

model Banner {
  id          String                   @id @default(cuid())
  vendorId    String?
  imageUrl    String
  redirectUrl String?
  slotType    String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean                  @default(true)
  createdAt   DateTime                 @default(now())
  metadata    Json?
  impressions BannerImpressionLedger[]
  campaign    BannerCampaign?

  @@index([vendorId])
  @@index([slotType, isActive])
  @@index([startDate, endDate])
  @@index([slotType, startDate, endDate, isActive])
}

model Notification {
  id             String   @id @default(cuid())
  userId         String?
  title          String
  body           String
  type           String
  targetAudience String?
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())
  user           User?    @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model Order {
  id                   String                     @id @default(cuid())
  orderNumber          String?                    @unique
  userId               String
  roomId               String?
  addressId            String?
  items                Json
  totalAmount          Int
  coinsUsed            Int                        @default(0)
  coinsUsedDebited     Boolean                    @default(false)
  status               OrderStatus                @default(PENDING)
  razorpayOrderId      String?
  awbNumber            String?
  courierPartner       String?
  createdAt            DateTime                   @default(now())
  updatedAt            DateTime                   @updatedAt
  abandonedCheckoutId  String?
  agentId              String?
  shippingCharges      Int                        @default(0)
  couponCode           String?
  discountAmount       Int                        @default(0)
  giftId               String?
  deliveredAt          DateTime?
  isReturnable         Boolean                    @default(true)
  returnWindow         Int                        @default(7)
  obdOtp               String?
  obdVerifiedAt        DateTime?
  checkout             AbandonedCheckout?         @relation(fields: [abandonedCheckoutId], references: [id])
  address              Address?                   @relation(fields: [addressId], references: [id])
  gift                 GiftSKU?                   @relation(fields: [giftId], references: [id])
  user                 User                       @relation(fields: [userId], references: [id])
  financialSnapshot    OrderFinancialSnapshot?
  settlement           OrderSettlement?
  payment              Payment?
  replacementChild     ReplacementOrder?          @relation("ReplacementOrder")
  replacementParent    ReplacementOrder[]         @relation("OriginalOrder")
  qcChecklist          ReturnQCChecklist?
  returns              ReturnRequest[]
  checkoutGroupId      String?
  checkoutGroup        CheckoutGroup?             @relation(fields: [checkoutGroupId], references: [id], onDelete: SetNull)
  referralRewardGrant  ReferralRewardGrant?
  deliverySlotSnapshot OrderDeliverySlotSnapshot?
  packingProof         OrderPackingProof?
  shipment             Shipment?
  tickets              SupportTicket[] @relation("OrderTickets")
  deliveries           Delivery[]      @relation("OrderDeliveries")
  refunds              Refund[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([razorpayOrderId])
  @@index([orderNumber])
  @@index([awbNumber])
  @@index([userId, status])
  @@index([status, createdAt])
  @@index([roomId, userId])
  @@index([checkoutGroupId])
}

model Product {
  id                   String             @id @default(cuid())
  vendorId             String
  title                String
  description          String?
  price                Int
  offerPrice           Int?
  stock                Int                @default(0)
  categoryId           String
  images               String[]
  isWholesale          Boolean            @default(false)
  wholesalePrice       Int?
  moq                  Int                @default(1)
  isActive             Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  brandName            String?
  dimensionUnit        String?            @default("cm")
  height               Float?
  length               Float?
  metaDescription      String?
  metaKeywords         String[]
  metaTitle            String?
  shippingClass        String?
  sku                  String?            @unique
  tags                 String[]
  weight               Float?
  weightUnit           String?            @default("kg")
  width                Float?
  allergenInformation  String?
  attributes           Json?
  basePreparationTime  Int                @default(0)
  costPrice            Int?
  isAttachmentRequired Boolean            @default(false)
  isCancelable         Boolean            @default(false)
  isInclusiveTax       Boolean            @default(false)
  isReturnable         Boolean            @default(false)
  mediaGallery         Json?
  minOrderQuantity     Int                @default(1)
  quantityStepSize     Int                @default(1)
  requiresOTP          Boolean            @default(false)
  rulesSnapshot        Json?
  shippingDetails      Json?
  storageInstructions  String?
  totalAllowedQuantity Int                @default(10)
  freeListingExpiresAt DateTime?
  expiryDate           DateTime? // Product expiry date (for auto-clearance)
  disableAutoClearance Boolean   @default(false) // Vendor can disable auto-clearance for specific products
  visibility           ProductVisibility  @default(DRAFT)
  popularityScore      Float              @default(0)
  embedding            Json?
  bowActionLogs        BowActionLog[]
  buyLater             BuyLater[]
  cartItems            CartItem[]
  category             Category           @relation(fields: [categoryId], references: [id])
  vendor               Vendor             @relation(fields: [vendorId], references: [id])
  specValues           ProductSpecValue[]
  variants             ProductVariant[]
  returnItems          ReturnItem[]
  reviews              Review[]
  rooms                Room[]
  productEvents        UserProductEvent[]
  vendorInquiries      VendorInquiry[]
  wishlists            Wishlist[]
  localPromotions      LocalPromotion[]
  Reel                 Reel[]
  ClearanceProduct     ClearanceProduct[]
  inventory            Inventory[]

  @@index([vendorId])
  @@index([categoryId])
  @@index([isActive])
  @@index([sku])
  @@index([categoryId, isActive])
  @@index([vendorId, isActive])
  @@index([price])
  @@index([createdAt])
  @@index([categoryId, isActive, price])
  @@index([categoryId, isActive, createdAt])
  @@index([isActive, price])
  @@index([isActive, createdAt])
  @@index([vendorId, stock])
}

model Admin {
  id              String          @id @default(cuid())
  email           String          @unique
  password        String
  role            String
  name            String?
  avatar          String?
  isActive        Boolean         @default(true)
  lastLoginAt     DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  assignedTickets SupportTicket[] @relation("AssignedTickets")
  authoredPosts   BlogPost[]      @relation("AuthorPosts")

  @@index([role])
  @@index([isActive])
}

model Report {
  id          String   @id @default(cuid())
  reporterId  String
  targetType  String
  targetId    String
  reason      String
  description String?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  reporter    User     @relation(fields: [reporterId], references: [id])

  @@index([status])
  @@index([targetType])
  @@index([reporterId])
}

model PlatformConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

model CoinValuation {
  id            String    @id @default(cuid())
  role          UserRole
  paisePerCoin  Int
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  setByUserId   String?
  createdAt     DateTime  @default(now())
  setByUser     User?     @relation("CoinValuationSetBy", fields: [setByUserId], references: [id])

  @@index([role, effectiveTo])
  @@index([role, effectiveFrom])
}

model Coupon {
  id             String    @id @default(cuid())
  code           String    @unique
  description    String?
  discountType   String
  discountValue  Int
  minOrderAmount Int?      @default(0)
  maxDiscount    Int?
  validFrom      DateTime  @default(now())
  validUntil     DateTime?
  usageLimit     Int?
  usedCount      Int       @default(0)
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  categoryIds    String[]
  minQuantity    Int?
  productIds     String[]
  vendorId       String?
  vendor         Vendor?   @relation(fields: [vendorId], references: [id])

  @@index([vendorId])
  @@index([isActive])
}

model AdminNote {
  id        String   @id @default(cuid())
  userId    String
  adminId   String
  note      String
  createdAt DateTime @default(now())
  admin     User     @relation("AdminAuthor", fields: [adminId], references: [id])
  user      User     @relation("UserNotes", fields: [userId], references: [id])
}

model AbandonedCheckout {
  id              String                 @id @default(cuid())
  userId          String?
  guestInfo       Json?
  cartSnapshot    Json
  financeSnapshot Json
  metadata        Json?
  status          CheckoutRecoveryStatus @default(NEW)
  agentId         String?
  lockedUntil     DateTime?
  createdAt       DateTime               @default(now())
  abandonedAt     DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  abandonReason   String?
  lastErrorCode   String?
  paymentMethod   String?
  agent           User?                  @relation("AgentCheckouts", fields: [agentId], references: [id])
  user            User?                  @relation(fields: [userId], references: [id])
  followups       CheckoutFollowup[]
  orders          Order[]

  @@index([status])
  @@index([agentId])
  @@index([abandonedAt])
  @@index([status, agentId])
}

model CheckoutFollowup {
  id         String            @id @default(cuid())
  checkoutId String
  agentId    String
  note       String
  outcome    CallOutcome?
  createdAt  DateTime          @default(now())
  agent      User              @relation(fields: [agentId], references: [id])
  checkout   AbandonedCheckout @relation(fields: [checkoutId], references: [id])
}

model ReturnRequest {
  id                    String            @id @default(cuid())
  returnNumber          String            @unique
  orderId               String
  userId                String
  vendorId              String?
  status                ReturnStatus      @default(PENDING_APPROVAL)
  reason                ReturnReason
  description           String?
  evidenceImages        String[]
  evidenceVideo         String?
  requestedAt           DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  pickupDate            DateTime?
  pickupAddress         Json?
  courierPartner        String?
  trackingId            String?
  qcNotes               String?
  qcBy                  String?
  replacementTrackingId String?
  approvedAt            DateTime?
  completedAt           DateTime?
  rejectedAt            DateTime?
  replacement           ReplacementOrder?
  items                 ReturnItem[]
  order                 Order             @relation(fields: [orderId], references: [id])
  user                  User              @relation(fields: [userId], references: [id])
  vendor                Vendor?           @relation(fields: [vendorId], references: [id])
  settlement            ReturnSettlement?
  timeline              ReturnTimeline[]
  refunds               Refund[]

  @@index([orderId])
  @@index([status])
  @@index([userId])
  @@index([vendorId])
  @@index([returnNumber])
}

model ReturnItem {
  id            String         @id @default(cuid())
  returnId      String
  productId     String
  quantity      Int
  reason        ReturnReason?
  condition     String?
  description   String?
  qcNotes       String?
  qcStatus      ItemCondition?
  variantId     String?
  product       Product        @relation(fields: [productId], references: [id])
  returnRequest ReturnRequest  @relation(fields: [returnId], references: [id])

  @@index([returnId])
  @@index([productId])
}

model ReturnSettlement {
  id             String        @id @default(cuid())
  returnId       String        @unique
  penaltyApplied Boolean       @default(false)
  penaltyAmount  Int           @default(0)
  adminNotes     String?
  createdAt      DateTime      @default(now())
  penaltyReason  String?
  updatedAt      DateTime      @updatedAt
  costBearer     CostBearer    @default(PLATFORM)
  returnRequest  ReturnRequest @relation(fields: [returnId], references: [id])
}

model ReturnTimeline {
  id            String        @id @default(cuid())
  returnId      String
  status        ReturnStatus
  action        String
  performedBy   String
  timestamp     DateTime      @default(now())
  notes         String?
  actorId       String?
  metadata      Json?
  returnRequest ReturnRequest @relation(fields: [returnId], references: [id])

  @@index([returnId])
  @@index([timestamp])
}

model OrderFinancialSnapshot {
  id               String   @id @default(cuid())
  orderId          String   @unique
  subtotal         Int
  taxAmount        Int
  shippingAmount   Int
  discountAmount   Int
  giftCost         Int
  commissionRate   Float
  commissionAmount Int
  vendorEarnings   Int
  platformEarnings Int
  currency         String   @default("INR")
  calculatedAt     DateTime @default(now())
  order            Order    @relation(fields: [orderId], references: [id])

  @@index([orderId])
}

model OrderSettlement {
  id         String           @id @default(cuid())
  orderId    String           @unique
  vendorId   String
  amount     Int
  status     SettlementStatus @default(PENDING)
  eligibleAt DateTime?
  settledAt  DateTime?
  createdAt  DateTime         @default(now())
  order      Order            @relation(fields: [orderId], references: [id])
  vendor     Vendor           @relation(fields: [vendorId], references: [id])

  @@index([vendorId, status])
}

model CategoryCommission {
  id             String   @id @default(cuid())
  categoryId     String   @unique
  commissionRate Float
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  category       Category @relation(fields: [categoryId], references: [id])
}

model ReplacementOrder {
  id              String        @id @default(cuid())
  originalOrderId String
  returnId        String        @unique
  newOrderId      String        @unique
  createdAt       DateTime      @default(now())
  newOrder        Order         @relation("ReplacementOrder", fields: [newOrderId], references: [id])
  originalOrder   Order         @relation("OriginalOrder", fields: [originalOrderId], references: [id])
  returnRequest   ReturnRequest @relation(fields: [returnId], references: [id])
}

model SearchClick {
  id        String   @id @default(cuid())
  query     String
  productId String
  userId    String?
  clickedAt DateTime @default(now())

  @@index([query])
  @@index([productId])
}

model TelecallerPerformance {
  id        String   @id @default(cuid())
  agentId   String
  date      DateTime
  assigned  Int      @default(0)
  contacted Int      @default(0)
  converted Int      @default(0)
  dropped   Int      @default(0)
  agent     User     @relation(fields: [agentId], references: [id])

  @@unique([agentId, date])
}

model ProductVariant {
  id         String          @id @default(cuid())
  productId  String
  sku        String?         @unique
  attributes Json
  price      Int?
  stock      Int             @default(0)
  status     VariationStatus @default(ACTIVE)
  product    Product         @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([stock])
}

model AuditLog {
  id        String   @id @default(cuid())
  adminId   String
  entity    String
  action    String
  details   Json?
  createdAt DateTime @default(now())
  entityId  String
  ipAddress String?
  userAgent String?
  admin     User     @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([entity])
  @@index([action])
  @@index([createdAt])
}

model CategorySpec {
  id            String             @id @default(cuid())
  categoryId    String
  key           String
  label         String
  labelTE       String?
  type          SpecType
  unit          String?
  required      Boolean            @default(false)
  options       Json?
  sortOrder     Int                @default(0)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  category      Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productValues ProductSpecValue[]

  @@unique([categoryId, key])
  @@index([categoryId, isActive])
  @@index([categoryId, sortOrder])
}

model ProductSpecValue {
  id        String       @id @default(cuid())
  productId String
  specId    String
  value     String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  product   Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  spec      CategorySpec @relation(fields: [specId], references: [id], onDelete: Cascade)

  @@unique([productId, specId])
  @@index([productId])
  @@index([specId])
}

model BowInteraction {
  id              String          @id @default(cuid())
  userId          String
  sessionId       String
  type            InteractionType
  query           String?
  response        String?
  intent          String?
  confidence      Float?
  actionType      BowActionType?
  actionPayload   Json?
  metadata        Json?
  context         Json?
  sentiment       String?
  escalated       Boolean         @default(false)
  createdAt       DateTime        @default(now())
  conversionEvent String?
  conversionValue Int?
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([escalated])
  @@index([sessionId])
  @@index([userId])
  @@index([sessionId, createdAt])
}

model ReferralTracking {
  id                String         @id @default(cuid())
  referrerId        String
  refereeId         String
  referralCode      String
  status            ReferralStatus @default(PENDING)
  coinsAwarded      Int            @default(0)
  firstOrderId      String?
  deviceFingerprint String?
  ipAddress         String?
  createdAt         DateTime       @default(now())
  completedAt       DateTime?
  referee           User           @relation("ReferralTracking_refereeIdToUser", fields: [refereeId], references: [id], onDelete: Cascade)
  referrer          User           @relation("ReferralTracking_referrerIdToUser", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([refereeId])
  @@index([referralCode])
  @@index([referrerId])
  @@index([status])
}

model VendorFollower {
  vendorId  String
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@id([vendorId, userId])
  @@index([userId])
  @@index([vendorId])
}

model VendorMembership {
  id             String         @id @default(cuid())
  vendorId       String         @unique
  tier           MembershipTier @default(FREE)
  price          Int            @default(0)
  skuLimit       Int            @default(10)
  imageLimit     Int            @default(3)
  commissionRate Float          @default(0.15)
  payoutCycle    PayoutCycle    @default(MONTHLY)
  features       Json?
  startDate      DateTime       @default(now())
  endDate        DateTime?
  isActive       Boolean        @default(true)
  autoRenew      Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  vendor         Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([tier])
  @@index([vendorId])
}

model VendorPayout {
  id            String       @id @default(cuid())
  vendorId      String
  amount        Int
  period        String
  status        PayoutStatus @default(PENDING)
  bankDetails   Json
  transactionId String?
  processedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  vendor        Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([vendorId])
}

model VendorPromotion {
  id          String          @id @default(cuid())
  vendorId    String
  type        PromotionType
  packageType String?
  productIds  String[]
  startDate   DateTime
  endDate     DateTime
  coinsCost   Int             @default(0)
  moneyCost   Int?
  status      PromotionStatus @default(ACTIVE)
  impressions Int             @default(0)
  clicks      Int             @default(0)
  orders      Int             @default(0)
  revenue     Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  metadata    Json?
  vendor      Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([startDate, endDate])
  @@index([status])
  @@index([type])
  @@index([vendorId])
  @@index([vendorId, status])
}

model Wallet {
  id        String        @id @default(cuid())
  userId    String        @unique
  balance   Int           @default(0)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  ledger    LedgerEntry[]
  user      User          @relation(fields: [userId], references: [id])

  @@index([userId])
}

model BuyLater {
  id               String   @id @default(cuid())
  userId           String
  productId        String
  variantId        String?
  targetPrice      Int
  currentPrice     Int
  quantity         Int      @default(1)
  isActive         Boolean  @default(true)
  isNotified       Boolean  @default(false)
  isAddedToCart    Boolean  @default(false)
  priceDropPercent Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  product          Product  @relation(fields: [productId], references: [id])
  user             User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([productId])
  @@index([isActive])
  @@index([isNotified])
  @@index([createdAt])
}

model Bet {
  id             String        @id @default(cuid())
  userId         String
  idempotencyKey String        @unique
  type           BetType       @default(SINGLE)
  selections     Json
  stake          Int
  odds           Float
  potentialWin   Int
  status         BetStatus     @default(PENDING)
  placedAt       DateTime      @default(now())
  settledAt      DateTime?
  result         String?
  payout         Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  user           User          @relation(fields: [userId], references: [id])
  ledgerEntries  LedgerEntry[]

  @@index([userId])
  @@index([status])
  @@index([idempotencyKey])
}

model LedgerEntry {
  id           String   @id @default(cuid())
  userId       String
  walletId     String
  betId        String?
  amount       Int
  type         String
  description  String
  balanceAfter Int
  createdAt    DateTime @default(now())
  bet          Bet?     @relation(fields: [betId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
  wallet       Wallet   @relation(fields: [walletId], references: [id])

  @@index([userId])
  @@index([walletId])
  @@index([betId])
  @@index([createdAt])
}

model LocalPromotion {
  id            String    @id @default(cuid())
  name          String?
  isActive      Boolean   @default(true)
  targetType    String
  centerLat     Float?
  centerLng     Float?
  radiusKm      Float?
  pincodes      Json?
  vendorId      String?
  categoryId    String?
  productId     String?
  percentOff    Int?
  flatOffAmount Int?
  freeShipping  Boolean   @default(false)
  boostOnly     Boolean   @default(false)
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  setByUserId   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  vendor        Vendor?   @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  category      Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  product       Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  setByUser     User?     @relation(fields: [setByUserId], references: [id], onDelete: SetNull)

  @@index([isActive, effectiveFrom, effectiveTo])
  @@index([vendorId])
  @@index([categoryId])
  @@index([productId])
}

model ReferralRewardRule {
  id            String                @id @default(cuid())
  minOrderPaise Int
  maxOrderPaise Int?
  coinsInviter  Int
  coinsInvitee  Int
  isActive      Boolean               @default(true)
  effectiveFrom DateTime              @default(now())
  effectiveTo   DateTime?
  setByAdminId  String?
  createdAt     DateTime              @default(now())
  updatedAt     DateTime              @updatedAt
  setByAdmin    User?                 @relation(fields: [setByAdminId], references: [id], onDelete: SetNull)
  grants        ReferralRewardGrant[]

  @@index([isActive, effectiveFrom, effectiveTo])
  @@index([minOrderPaise])
  @@index([maxOrderPaise])
  @@index([setByAdminId])
}

model ReferralRewardGrant {
  id                     String             @id @default(cuid())
  orderId                String             @unique
  inviterUserId          String
  inviteeUserId          String
  ruleId                 String
  orderValuePaiseAtAward Int
  coinsInviterAtAward    Int
  coinsInviteeAtAward    Int
  createdAt              DateTime           @default(now())
  order                  Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  inviterUser            User               @relation("ReferralInviter", fields: [inviterUserId], references: [id], onDelete: Cascade)
  inviteeUser            User               @relation("ReferralInvitee", fields: [inviteeUserId], references: [id], onDelete: Cascade)
  rule                   ReferralRewardRule @relation(fields: [ruleId], references: [id], onDelete: Restrict)

  @@index([inviterUserId, createdAt])
  @@index([inviteeUserId, createdAt])
  @@index([ruleId])
}

model CheckoutGroup {
  id               String              @id @default(uuid())
  userId           String
  provider         String              @default("RAZORPAY")
  providerOrderId  String?
  totalAmountPaise Int
  currency         String              @default("INR")
  status           CheckoutGroupStatus @default(PENDING_PAYMENT)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders           Order[]

  @@index([userId, createdAt])
  @@index([providerOrderId])
}

model OrderDeliverySlotSnapshot {
  id          String             @id @default(uuid())
  orderId     String             @unique
  vendorId    String
  slotStartAt DateTime
  slotEndAt   DateTime
  timezone    String             @default("Asia/Kolkata")
  source      DeliverySlotSource @default(AUTO)
  createdAt   DateTime           @default(now())
  order       Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  vendor      Vendor             @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId, slotStartAt])
}

model VendorServiceArea {
  id        String   @id @default(uuid())
  vendorId  String
  type      String
  centerLat Float?
  centerLng Float?
  radiusKm  Float?
  polygon   Json?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([isActive])
}

model VendorDeliveryWindow {
  id          String   @id @default(uuid())
  vendorId    String
  weekday     Int
  startMinute Int
  endMinute   Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId, weekday, isActive])
  @@index([vendorId, isActive])
}

model OrderPackingProof {
  id               String   @id @default(uuid())
  orderId          String   @unique
  vendorId         String
  uploadedByUserId String
  videoPath        String
  videoMime        String?
  videoSizeBytes   Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  order            Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  vendor           Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  uploadedByUser   User     @relation(fields: [uploadedByUserId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([createdAt])
}

model PickupPoint {
  id           String     @id @default(uuid())
  vendorId     String
  name         String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  pincode      String
  latitude     Float?
  longitude    Float?
  timings      Json?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  vendor       Vendor     @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  shipments    Shipment[]

  @@index([vendorId])
  @@index([pincode])
}

model Shipment {
  id              String       @id @default(uuid())
  orderId         String       @unique
  mode            String
  status          String
  courierProvider String?
  awb             String?
  trackingUrl     String?
  pickupPointId   String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  order           Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  pickupPoint     PickupPoint? @relation(fields: [pickupPointId], references: [id], onDelete: SetNull)

  @@index([awb])
  @@index([pickupPointId])
}

model PincodeGeo {
  pincode   String    @id
  latitude  Float
  longitude Float
  source    GeoSource @default(PINCODE_DB)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ============================================
// LEDGER MODELS (NO COUNTERS - ALL LEDGER-BASED)
// ============================================

model VendorBowCoinLedger {
  id           String   @id @default(cuid())
  vendorId     String
  sourceType   String // RATING_5_STAR, ADMIN_ADJUSTMENT, PENALTY, etc.
  sourceId     String? // ratingId, adminId, orderId, etc.
  coinsDelta   Int // +2 for rating, -5 for penalty, etc.
  balanceAfter Int // Calculated balance after this entry
  createdAt    DateTime @default(now())
  vendor       Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId, createdAt])
  @@index([sourceType, sourceId])
}

model BannerImpressionLedger {
  id        String    @id @default(cuid())
  bannerId  String
  userId    String? // null for anonymous
  viewedAt  DateTime  @default(now())
  clickedAt DateTime?
  banner    Banner    @relation(fields: [bannerId], references: [id], onDelete: Cascade)
  user      User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([bannerId, viewedAt])
  @@index([userId, viewedAt])
}

model ReelInteractionLedger {
  id              String   @id @default(cuid())
  reelId          String
  userId          String
  interactionType String // VIEW, LIKE
  createdAt       DateTime @default(now())
  reel            Reel     @relation(fields: [reelId], references: [id], onDelete: Cascade)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([reelId, userId, interactionType]) // Prevent duplicate views/likes
  @@index([reelId, interactionType])
  @@index([userId, createdAt])
}

// ============================================
// DISCIPLINE STATE MACHINE (NO COUNTERS)
// ============================================

model VendorDisciplineEvent {
  id          String   @id @default(cuid())
  vendorId    String
  eventType   String // STRIKE_ADDED, STRIKE_REMOVED, AUTO_BLOCKED, AUTO_UNBLOCKED, ADMIN_OVERRIDE
  orderId     String? // For delivery-related events
  reason      String?
  performedBy String? // adminId for overrides, null for auto
  createdAt   DateTime @default(now())
  vendor      Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId, createdAt])
  @@index([eventType])
}

model VendorDisciplineState {
  vendorId             String   @id
  state                String // ACTIVE, WARNING, BLOCKED
  activeStrikes        Int      @default(0) // Derived from events
  consecutiveSuccesses Int      @default(0) // Derived from orders
  lastStateChange      DateTime @default(now())
  updatedAt            DateTime @updatedAt
  vendor               Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([state])
}

// ============================================
// CORE MODELS (NO COUNTERS)
// ============================================

model Story {
  id               String   @id @default(cuid())
  vendorId         String
  mediaUrl         String
  mediaType        String // IMAGE, VIDEO
  expiresAt        DateTime
  isActive         Boolean  @default(true)
  flaggedForReview Boolean  @default(false)
  createdAt        DateTime @default(now())
  vendor           Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId, expiresAt])
  @@index([isActive, expiresAt])
}

model Reel {
  id               String                  @id @default(cuid())
  vendorId         String?
  creatorId        String?
  mediaUrl         String
  thumbnailUrl     String?
  productId        String?
  description      String?
  flaggedForReview Boolean                 @default(false)
  createdAt        DateTime                @default(now())
  vendor           Vendor?                 @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  creator          CreatorProfile?         @relation(fields: [creatorId], references: [id], onDelete: SetNull)
  product          Product?                @relation(fields: [productId], references: [id], onDelete: SetNull)
  interactions     ReelInteractionLedger[]

  @@index([vendorId])
  @@index([creatorId])
  @@index([productId])
  @@index([createdAt])
}

model ClearanceProduct {
  id             String   @id @default(cuid())
  productId      String
  vendorId       String
  clearancePrice Int
  originalPrice  Int
  expiryDate     DateTime
  quantity       Int
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  product        Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  vendor         Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId, isActive])
  @@index([expiryDate, isActive])
}

model CreatorProfile {
  id              String   @id @default(cuid())
  userId          String   @unique
  displayName     String
  bio             String?
  profileImageUrl String?
  isVerified      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reels           Reel[]

  @@index([userId])
}

model VendorDocument {
  id              String    @id @default(cuid())
  vendorId        String
  documentType    String // AADHAAR, PAN, BANK, GST, UPI
  documentUrl     String
  status          String    @default("PENDING") // PENDING, APPROVED, REJECTED
  uploadedAt      DateTime  @default(now())
  reviewedAt      DateTime?
  reviewedBy      String? // adminId
  rejectionReason String?
  vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId, status])
  @@index([status])
}

model BannerCampaign {
  id             String   @id @default(cuid())
  bannerId       String   @unique
  vendorId       String
  campaignType   String // WEEKLY, MONTHLY
  targetAudience String // CUSTOMERS, RETAILERS
  startDate      DateTime
  endDate        DateTime
  amountPaid     Int // In paise
  paymentStatus  String   @default("PENDING") // PENDING, PAID, REFUNDED
  createdAt      DateTime @default(now())
  banner         Banner   @relation(fields: [bannerId], references: [id], onDelete: Cascade)
  vendor         Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([vendorId])
  @@index([startDate, endDate])
}

model ContentModeration {
  id          String    @id @default(cuid())
  contentType String // STORY, REEL
  contentId   String
  flaggedBy   String? // userId (null for auto-flag)
  reason      String
  status      String    @default("PENDING") // PENDING, APPROVED, REJECTED
  reviewedBy  String? // adminId
  reviewedAt  DateTime?
  createdAt   DateTime  @default(now())

  @@index([contentType, contentId])
  @@index([status])
}

// ============================================
// REFUNDS MODULE
// ============================================

model Refund {
  id              String       @id @default(cuid())
  refundNumber    String       @unique
  orderId         String
  order           Order        @relation(fields: [orderId], references: [id])
  returnId        String?
  return          ReturnRequest? @relation(fields: [returnId], references: [id])
  userId          String
  user            User         @relation(fields: [userId], references: [id], name: "UserRefunds")
  amount          Int          // in paise
  reason          String
  status          RefundStatus @default(PENDING)
  method          RefundMethod @default(ORIGINAL_PAYMENT)
  transactionId   String?
  processedBy     String?
  processedAt     DateTime?
  rejectionReason String?
  notes           String?
  metadata        Json?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@index([returnId])
  @@index([refundNumber])
  @@index([createdAt])
}

// ============================================
// SUPPORT/TICKETS MODULE
// ============================================

model SupportTicket {
  id              String          @id @default(cuid())
  ticketNumber    String          @unique
  userId          String
  user            User            @relation(fields: [userId], references: [id], name: "UserTickets")
  category        TicketCategory
  subject         String
  description     String          @db.Text
  priority        TicketPriority  @default(MEDIUM)
  status          TicketStatus    @default(OPEN)
  assignedTo      String?
  assignedAdmin   Admin?          @relation(fields: [assignedTo], references: [id], name: "AssignedTickets")
  orderId         String?
  order           Order?          @relation(fields: [orderId], references: [id], name: "OrderTickets")
  productId       String?
  vendorId        String?
  attachments     String[]
  tags            String[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  closedAt        DateTime?
  firstResponseAt DateTime?
  resolvedAt      DateTime?
  messages        TicketMessage[]

  @@index([userId])
  @@index([status])
  @@index([assignedTo])
  @@index([category])
  @@index([priority])
  @@index([createdAt])
  @@index([orderId])
}

model TicketMessage {
  id          String        @id @default(cuid())
  ticketId    String
  ticket      SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  senderId    String
  senderType  MessageSender
  senderName  String
  message     String        @db.Text
  attachments String[]
  isInternal  Boolean       @default(false)
  createdAt   DateTime      @default(now())

  @@index([ticketId])
  @@index([createdAt])
}

model TicketTemplate {
  id        String          @id @default(cuid())
  name      String
  category  TicketCategory?
  subject   String?
  content   String          @db.Text
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([category])
  @@index([isActive])
}

// ============================================
// EMPLOYEE MANAGEMENT MODULE
// ============================================

model Employee {
  id          String       @id @default(cuid())
  employeeId  String       @unique
  name        String
  email       String       @unique
  mobile      String       @unique
  password    String
  avatar      String?
  role        EmployeeRole
  department  String?
  permissions String[]
  isActive    Boolean      @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([role])
  @@index([department])
  @@index([isActive])
}

// ============================================
// DRIVER MANAGEMENT MODULE
// ============================================

model Driver {
  id              String           @id @default(cuid())
  driverId        String           @unique
  name            String
  mobile          String           @unique
  email           String?
  avatar          String?
  vehicleType     VehicleType
  vehicleNumber   String
  licenseNumber   String
  licenseExpiry   DateTime
  status          DriverStatus     @default(PENDING)
  isAvailable     Boolean          @default(false)
  isOnline        Boolean          @default(false)
  currentLocation Json?
  rating          Float            @default(5.0)
  totalDeliveries Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  documents       DriverDocument[]
  deliveries      Delivery[]

  @@index([status])
  @@index([isAvailable])
  @@index([isOnline])
}

model DriverDocument {
  id          String         @id @default(cuid())
  driverId    String
  driver      Driver         @relation(fields: [driverId], references: [id], onDelete: Cascade)
  type        DocumentType
  documentUrl String
  status      DocumentStatus @default(PENDING)
  verifiedBy  String?
  verifiedAt  DateTime?
  expiryDate  DateTime?
  notes       String?
  createdAt   DateTime       @default(now())

  @@index([driverId])
  @@index([status])
}

model Delivery {
  id              String         @id @default(cuid())
  deliveryNumber  String         @unique
  orderId         String
  order           Order          @relation(fields: [orderId], references: [id], name: "OrderDeliveries")
  driverId        String?
  driver          Driver?        @relation(fields: [driverId], references: [id])
  pickupAddress   Json
  deliveryAddress Json
  status          DeliveryStatus @default(PENDING)
  distance        Float?
  estimatedTime   Int?           // minutes
  actualTime      Int?
  pickupOtp       String?
  deliveryOtp     String?
  pickedAt        DateTime?
  deliveredAt     DateTime?
  proofImage      String?
  notes           String?
  rating          Int?
  feedback        String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([orderId])
  @@index([driverId])
  @@index([status])
  @@index([createdAt])
}

// ============================================
// NOTIFICATION TEMPLATES & CAMPAIGNS
// ============================================

model NotificationTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  title     String
  body      String
  imageUrl  String?
  action    String?
  data      Json?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

model NotificationCampaign {
  id             String    @id @default(cuid())
  name           String
  templateId     String?
  title          String
  body           String
  imageUrl       String?
  targetAudience Json      // { role: [], status: [], location: [] }
  scheduledAt    DateTime?
  sentAt         DateTime?
  totalSent      Int       @default(0)
  totalOpened    Int       @default(0)
  totalClicked   Int       @default(0)
  status         String    @default("draft") // draft, scheduled, sending, sent, cancelled
  createdBy      String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
}

// ============================================
// CMS MODULE
// ============================================

model CMSPage {
  id            String   @id @default(cuid())
  slug          String   @unique
  title         String
  content       String   @db.Text
  excerpt       String?
  metaTitle     String?
  metaDesc      String?
  featuredImage String?
  template      String   @default("default")
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slug])
  @@index([isActive])
  @@index([sortOrder])
}

model CMSMenu {
  id        String        @id @default(cuid())
  name      String        @unique
  location  MenuLocation
  items     CMSMenuItem[]
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([location])
  @@index([isActive])
}

model CMSMenuItem {
  id        String       @id @default(cuid())
  menuId    String
  menu      CMSMenu      @relation(fields: [menuId], references: [id], onDelete: Cascade)
  label     String
  url       String
  icon      String?
  target    String       @default("_self")
  parentId  String?
  parent    CMSMenuItem? @relation("MenuItemChildren", fields: [parentId], references: [id])
  children  CMSMenuItem[] @relation("MenuItemChildren")
  sortOrder Int          @default(0)
  isActive  Boolean      @default(true)

  @@index([menuId])
  @@index([parentId])
  @@index([sortOrder])
}

// ============================================
// BLOG MODULE
// ============================================

model BlogPost {
  id            String        @id @default(cuid())
  slug          String        @unique
  title         String
  excerpt       String?
  content       String        @db.Text
  coverImage    String?
  categoryId    String?
  category      BlogCategory? @relation(fields: [categoryId], references: [id])
  authorId      String
  author        Admin         @relation(fields: [authorId], references: [id], name: "AuthorPosts")
  tags          String[]
  status        PostStatus    @default(DRAFT)
  isFeatured    Boolean       @default(false)
  publishedAt   DateTime?
  viewCount     Int           @default(0)
  readTime      Int?          // minutes
  seoTitle      String?
  seoDesc       String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([categoryId])
  @@index([authorId])
  @@index([status])
  @@index([isFeatured])
  @@index([publishedAt])
  @@index([slug])
}

model BlogCategory {
  id          String         @id @default(cuid())
  slug        String         @unique
  name        String
  description String?
  image       String?
  parentId    String?
  parent      BlogCategory?  @relation("CategoryChildren", fields: [parentId], references: [id])
  children    BlogCategory[] @relation("CategoryChildren")
  posts       BlogPost[]
  sortOrder   Int            @default(0)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())

  @@index([parentId])
  @@index([isActive])
  @@index([slug])
}

model ReturnQCChecklist {
  id                    String   @id @default(cuid())
  orderId               String   @unique
  inspectorId           String
  status                Boolean  @default(false)
  isOriginalPackaging   Boolean  @default(false)
  isUnused              Boolean  @default(false)
  allAccessoriesPresent Boolean  @default(false)
  hasPhysicalDamage     Boolean  @default(false)
  imeiMatch             Boolean  @default(true)
  photos                String[]
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  order                 Order    @relation(fields: [orderId], references: [id])
}

model Warehouse {
  id        String      @id @default(cuid())
  name      String
  location  String
  isActive  Boolean     @default(true)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  inventory Inventory[]
}

model Inventory {
  id               String          @id @default(cuid())
  productId        String
  warehouseId      String?
  stock            Int             @default(0)
  reservedStock    Int             @default(0)
  reorderPoint     Int             @default(10)
  reorderQuantity  Int             @default(50)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  product          Product         @relation(fields: [productId], references: [id])
  warehouse        Warehouse?      @relation(fields: [warehouseId], references: [id])
  movements        StockMovement[]

  @@index([productId])
  @@index([warehouseId])
}

model StockMovement {
  id          String              @id @default(cuid())
  inventoryId String
  type        StockMovementType
  quantity    Int
  reason      String?
  reference   String?
  createdBy   String
  createdAt   DateTime            @default(now())
  inventory   Inventory           @relation(fields: [inventoryId], references: [id])

  @@index([inventoryId])
  @@index([createdAt])
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER
}

enum SettlementStatus {
  PENDING
  ELIGIBLE
  SETTLED
  REVERSED
}

enum ReturnStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  PICKUP_SCHEDULED
  PICKUP_COMPLETED
  IN_TRANSIT
  RECEIVED_AT_WAREHOUSE
  QC_IN_PROGRESS
  QC_PASSED
  QC_FAILED
  REFUND_INITIATED
  REFUND_COMPLETED
  REPLACEMENT_INITIATED
  REPLACEMENT_SHIPPED
  REPLACEMENT_COMPLETED
  CANCELLED
}

enum ReturnReason {
  DAMAGED_PRODUCT
  WRONG_ITEM
  MISSING_PARTS
  QUALITY_ISSUE
  SIZE_FIT_ISSUE
  OTHER
  NOT_AS_DESCRIBED
  DEFECTIVE
  CHANGED_MIND
}

enum ItemCondition {
  UNOPENED
  OPENED_UNUSED
  USED_LIKE_NEW
  USED_GOOD
  USED_FAIR
  DAMAGED
  DEFECTIVE
}

enum CostBearer {
  PLATFORM
  VENDOR
  CUSTOMER
  SHARED
}

enum CartInsightType {
  HESITATION
  THRESHOLD_NEAR
  BUNDLE_OPPORTUNITY
  PRICE_SENSITIVITY
  REPEAT_REMOVAL
  GIFT_ELIGIBLE
}

enum InsightSeverity {
  LOW
  MEDIUM
  HIGH
}

enum BowActionType {
  ADD_TO_CART
  REMOVE_FROM_CART
  UPDATE_QUANTITY
  APPLY_COUPON
  SELECT_GIFT
  NAVIGATE
  VIEW_CART
  GET_RECOMMENDATIONS
  CLIENT_CONTROL
  ROOM_NUDGE
  SUGGEST_BUNDLE
  SUGGEST_GIFT
  SUGGEST_UPSELL
  REMOVE_SUGGESTION
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING
  BANNED
}

enum UserRole {
  CUSTOMER
  VENDOR
  WHOLESALER
  ADMIN
  SUPER_ADMIN
  TELECALLER
}

enum RoomStatus {
  LOCKED
  ACTIVE
  UNLOCKED
  EXPIRED
  OPEN
  COMPLETED
}

enum RoomType {
  GOAL_BASED
  LINEAR_DISCOUNT
}

enum MemberStatus {
  PENDING
  ORDERED
  CONFIRMED
  CANCELLED
}

enum RoomBoostType {
  PRIORITY_VISIBILITY
  UNLOCK_ACCELERATOR
  SPONSORED_PRODUCT
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PACKED
  SHIPPED
  DELIVERED
  CANCELLED
  CREATED
  PENDING_PAYMENT
  PAID
  OUT_FOR_INSPECTION
  RETURN_REQUESTED
  QC_IN_PROGRESS
  RETURN_PICKED_UP
  RETURN_RECEIVED
  RETURNED
  REFUNDED
}

enum VendorRole {
  RETAILER
  WHOLESALER
}

enum ReviewStatus {
  ACTIVE
  REPORTED
  HIDDEN
  DELETED
  PENDING
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentIntentPurpose {
  BANNER_SLOT
  ROOM_PROMOTION
  VENDOR_MEMBERSHIP
}

enum InquiryStatus {
  PENDING
  RESPONDED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum UserProductEventType {
  PRODUCT_VIEW
  PRODUCT_CLICK
  ADD_TO_CART
  REMOVE_FROM_CART
  WISHLIST_ADD
  PURCHASE
}

enum RiskTag {
  LOW
  MEDIUM
  HIGH
}

enum ValueTag {
  NORMAL
  VIP
}

enum CheckoutRecoveryStatus {
  NEW
  ASSIGNED
  FOLLOW_UP
  CONVERTED
  DROPPED
}

enum CallOutcome {
  NOT_REACHABLE
  FOLLOW_UP_SCHEDULED
  CONVERTED
  DROPPED
  WRONG_NUMBER
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
  FAILED
}

enum RefundMethod {
  ORIGINAL_PAYMENT
  WALLET
  BANK_TRANSFER
  UPI
}

enum TicketCategory {
  ORDER_ISSUE
  PAYMENT_ISSUE
  RETURN_REFUND
  PRODUCT_INQUIRY
  DELIVERY_ISSUE
  VENDOR_COMPLAINT
  TECHNICAL_ISSUE
  ACCOUNT_ISSUE
  OTHER
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  WAITING_VENDOR
  ESCALATED
  RESOLVED
  CLOSED
}

enum MessageSender {
  CUSTOMER
  VENDOR
  ADMIN
  SYSTEM
}

enum VehicleType {
  BIKE
  SCOOTER
  CAR
  VAN
  TRUCK
}

enum DriverStatus {
  PENDING
  DOCUMENTS_SUBMITTED
  VERIFIED
  ACTIVE
  SUSPENDED
  BLOCKED
}

enum DeliveryStatus {
  PENDING
  ASSIGNED
  ACCEPTED
  PICKING_UP
  PICKED_UP
  IN_TRANSIT
  ARRIVED
  DELIVERED
  FAILED
  CANCELLED
}

enum MenuLocation {
  HEADER
  FOOTER
  MOBILE_NAV
  SIDEBAR
}

enum PostStatus {
  DRAFT
  REVIEW
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum EmployeeRole {
  TELECALLER
  SUPPORT_AGENT
  CONTENT_MODERATOR
  WAREHOUSE_STAFF
  FINANCE_STAFF
  OPERATIONS_MANAGER
}

enum DocumentType {
  AADHAAR
  PAN
  LICENSE
  RC_BOOK
  INSURANCE
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AttributeScope {
  PRODUCT
  VARIATION
}

enum ProductVisibility {
  DRAFT
  PUBLISHED
  BLOCKED
}

enum VariationStatus {
  ACTIVE
  OUT_OF_STOCK
  ARCHIVED
}

enum MediaType {
  IMAGE
  VIDEO
  GIF
}

enum VendorStatus {
  ACTIVE
  SUSPENDED
}

enum SpecType {
  TEXT
  NUMBER
  SELECT
  BOOLEAN
  MULTISELECT
}

enum MembershipTier {
  FREE
  BASIC
  PRO
  PREMIUM
  ELITE
}

enum PayoutCycle {
  WEEKLY
  BIWEEKLY
  MONTHLY
  INSTANT
}

enum PromotionType {
  BANNER
  ROOM_PACKAGE
  FEATURED
}

enum PromotionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum InteractionType {
  CHAT
  VOICE
  RECOMMENDATION
  ACTION
}

enum ReferralStatus {
  PENDING
  COMPLETED
  EXPIRED
}

enum BetStatus {
  PENDING
  PLACED
  SETTLED_WIN
  SETTLED_LOSE
  CANCELLED
  VOIDED
}

enum BetType {
  SINGLE
  MULTIPLE
  SYSTEM
}

enum CheckoutGroupStatus {
  PENDING_PAYMENT
  PAID
  FAILED
}

enum DeliverySlotSource {
  AUTO
  CUSTOMER
}

enum GeoSource {
  PINCODE_DB
  NOMINATIM
  MANUAL
}

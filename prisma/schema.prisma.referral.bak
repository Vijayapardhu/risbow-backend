// 1ï¸âƒ£ ProductSearchMiss: Tracks failed searches with analytics for demand mining
model ProductSearchMiss {
  id                 String    @id @default(cuid())
  query              String
  normalizedQuery    String
  keywords           String[]
  inferredCategoryId String?
  userId             String?
  count              Int       @default(1)
  firstSearchedAt    DateTime  @default(now())
  lastSearchedAt     DateTime  @updatedAt
  resolved           Boolean   @default(false)
  resolvedProductId  String?
  metadata           Json?
  region             String?   // Region where search originated

  user     User?     @relation(fields: [userId], references: [id])
  category Category? @relation(fields: [inferredCategoryId], references: [id])

  @@index([normalizedQuery])
  @@index([count])
  @@index([resolved])
  @@index([lastSearchedAt])
  @@index([region])
}

// 1ï¸âƒ£b SearchTrending: Tracks trending searches by region for autocomplete and analytics
model SearchTrending {
  id        String   @id @default(cuid())
  query     String
  region    String?  @default("global")
  count     Int      @default(1)
  lastSeen  DateTime @default(now())

  @@unique([query, region])
  @@index([region, count])
  @@index([lastSeen])
}

// 2ï¸âƒ£ CartInsight: Analyzes cart state for behavioral patterns and risk
model CartInsight {
  id              String         @id @default(cuid())
  userId          String
  cartValue       Int
  itemCount       Int
  categories      String[]
  cartPattern     String // SINGLE_ITEM, VALUE_BUYER, BUNDLE_POTENTIAL, etc.
  hesitationScore Float
  abandonRisk     Float
  type            CartInsightType
  severity        InsightSeverity
  triggeredAt     DateTime       @default(now())
  resolvedAt      DateTime?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([cartPattern])
  @@index([triggeredAt])
  @@index([type])
  @@index([severity])
}

// 3ï¸âƒ£ RecommendationEvent: Tracks AI/System recommendations and their conversion
model RecommendationEvent {
  id              String   @id @default(cuid())
  userId          String
  source          String // BOW, CART_PAGE, SEARCH
  strategy        String // BUNDLE, THRESHOLD, LOOK, ALTERNATIVE
  productIds      String[]
  accepted        Boolean?
  cartValueBefore Int
  cartValueAfter  Int?
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([strategy])
  @@index([accepted])
}

// 6ï¸âƒ£ UserProductEvent: Commerce-grade event stream for personalization and analytics.
// Money safety: store prices in integer paise.
model UserProductEvent {
  id        String           @id @default(cuid())
  userId    String?
  sessionId String?
  type      UserProductEventType
  source    String?          // PDP | SEARCH | CART | RECO | ROOM | CHECKOUT
  productId String
  variantId String?
  quantity  Int?
  price     Int?             // paise at event time (best-effort snapshot)
  metadata  Json?
  createdAt DateTime         @default(now())

  user    User?    @relation(fields: [userId], references: [id])
  product Product  @relation(fields: [productId], references: [id])

  @@index([userId, createdAt])
  @@index([productId, createdAt])
  @@index([type, createdAt])
  @@index([source, createdAt])
}

// 4ï¸âƒ£ BowActionLog: Tracks automatic Bow actions with guardrails and attribution
model BowActionLog {
  id              String         @id @default(cuid())
  userId          String
  actionType      BowActionType
  productId       String?
  variantId       String?
  quantity        Int?
  price           Int?
  reason          String // Why this action was taken
  guardrailCheck  Json? // Stock, price, user preferences validation
  autoReversed    Boolean        @default(false)
  reverseReason   String?
  attributedRevenue Int? // Revenue attributed to this action
  createdAt       DateTime       @default(now())
  reversedAt      DateTime?

  user User @relation(fields: [userId], references: [id])
  product Product? @relation(fields: [productId], references: [id])

  @@index([userId])
  @@index([actionType])
  @@index([productId])
  @@index([createdAt])
  @@index([autoReversed])
}

// 5ï¸âƒ£ UserPreferenceProfile: Safe preference storage for personalization
model UserPreferenceProfile {
  id                    String   @id @default(cuid())
  userId                String   @unique
  preferredCategories   String[]
  preferredBrands       String[]
  sizePreferences       String[]
  priceSensitivity      String   @default("MEDIUM") // LOW, MEDIUM, HIGH
  colorAffinity         String[]
  styleTags             String[] // casual, formal, festive, etc.
  lastUpdated           DateTime @updatedAt
  confidenceScore       Float    @default(0.1) // 0.0 to 1.0

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([priceSensitivity])
}
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum SettlementStatus {
  PENDING
  ELIGIBLE
  SETTLED
  REVERSED
}

model User {
  id                                                 String              @id @default(cuid())
  mobile                                             String              @unique
  name                                               String?
  email                                              String?             @unique
  password                                           String?
  role                                               UserRole            @default(CUSTOMER)
  status                                             UserStatus          @default(ACTIVE)
  coinsBalance                                       Int                 @default(0)
  referralCode                                       String              @unique @default(cuid())
  referredBy                                         String?
  dateOfBirth                                        DateTime?
  gender                                             String?
  size                                               String?
  footwearSize                                       Int?
  stylePrefs                                         String?
  colors                                             String?
  riskTag                                            RiskTag             @default(LOW)
  valueTag                                           ValueTag            @default(NORMAL)
  isCodDisabled                                      Boolean             @default(false)
  isRefundsDisabled                                  Boolean             @default(false)
  createdAt                                          DateTime            @default(now())
  forceLogoutAt                                      DateTime?
  kycDocuments                                       Json?
  kycStatus                                          String              @default("NOT_SUBMITTED")
  miscDocuments                                      Json?
  updatedAt                                          DateTime            @updatedAt
  metadata                                           Json?               @default("{}")
  assignedLeads                                      AbandonedCheckout[] @relation("AgentCheckouts")
  abandonedCheckouts                                 AbandonedCheckout[]
  addresses                                          Address[]
  authoredNotes                                      AdminNote[]         @relation("AdminAuthor")
  receivedNotes                                      AdminNote[]         @relation("UserNotes")
  auditLogs                                          AuditLog[]
  BowInteraction                                     BowInteraction[]
  cart                                               Cart?
  leadFollowups                                      CheckoutFollowup[]
  coinLedger                                         CoinLedger[]
  notifications                                      Notification[]
  devices                                            UserDevice[]
  orders                                             Order[]
  ReferralTracking_ReferralTracking_refereeIdToUser  ReferralTracking[]  @relation("ReferralTracking_refereeIdToUser")
  ReferralTracking_ReferralTracking_referrerIdToUser ReferralTracking[]  @relation("ReferralTracking_referrerIdToUser")
  reports                                            Report[]
  returns                                            ReturnRequest[]
  reviews                                            Review[]
  createdRooms                                       Room[]
  rooms                                              RoomMember[]
  VendorFollower                                     VendorFollower[]
  wishlist                                           Wishlist[]
  wallet                                             Wallet?
  buyLater                                           BuyLater[]
  bets                                               Bet[]
  ledger                                             LedgerEntry[]
  telecallerPerformance                              TelecallerPerformance[]

   productSearchMisses                                ProductSearchMiss[]
   cartInsights                                       CartInsight[]
   recommendationEvents                               RecommendationEvent[]
   bowActionLogs                                      BowActionLog[]
   userPreferenceProfile                              UserPreferenceProfile?
   productEvents                                      UserProductEvent[]
   vendorInquiriesRequested                           VendorInquiry[] @relation("VendorInquiryRequester")
   paymentIntentsCreated                              PaymentIntent[] @relation("PaymentIntentCreatedBy")
   coinValuationsSet                                  CoinValuation[] @relation("CoinValuationSetBy")

  @@index([role])
  @@index([status])
  @@index([referredBy])
}

// User device tokens for push notifications (FCM).
// This is required for real push delivery; otherwise we only store in-app notifications.
model UserDevice {
  id         String    @id @default(cuid())
  userId     String
  platform   String    // ANDROID | IOS | WEB
  token      String    @unique
  isActive   Boolean   @default(true)
  lastSeenAt DateTime  @default(now())
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([lastSeenAt])
}

model Room {
  id              String       @id @default(cuid())
  name            String
  size            Int
  status          RoomStatus   @default(LOCKED)
  offerId         String       @default("")
  startAt         DateTime
  endAt           DateTime
  unlockMinOrders Int
  unlockMinValue  Int
  createdById     String?
  isSystemRoom    Boolean      @default(false)
  memberCount     Int          @default(1)
  createdAt       DateTime     @default(now())
  createdBy       User?        @relation(fields: [createdById], references: [id])
  members         RoomMember[]
  boosts          RoomBoost[]
  insights        RoomInsight[]

  // Phase 3.1: Group Discount Room fields
  type            RoomType     @default(GOAL_BASED)
  productId       String?
  maxDiscount     Float?       // Max discount percentage (e.g. 80.0)
  maxMembers      Int?         // Limit of members (can use size but let's be explicit as per request)
  
  product         Product?     @relation(fields: [productId], references: [id])

  @@index([status, endAt])
  @@index([createdById])
  @@index([productId])
}

model RoomBoost {
  id          String        @id @default(cuid())
  roomId      String
  vendorId    String?
  type        RoomBoostType
  coinsCost   Int
  startAt     DateTime
  endAt     DateTime
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())

  room        Room     @relation(fields: [roomId], references: [id])

  @@index([roomId])
  @@index([type, isActive])
  @@index([startAt, endAt])
}

model RoomInsight {
  id        String   @id @default(cuid())
  roomId    String
  metric    String
  value     Float
  createdAt DateTime @default(now())

  room      Room     @relation(fields: [roomId], references: [id])

  @@index([roomId])
  @@index([metric])
}

model WeeklyOffer {
  id        String   @id @default(cuid())
  name      String
  startAt   DateTime
  endAt     DateTime
  isActive  Boolean  @default(true)
  rules     Json?
  createdAt DateTime @default(now())
}

model RoomMember {
  roomId String
  userId String
  status MemberStatus @default(PENDING)
  room   Room         @relation(fields: [roomId], references: [id])
  user   User         @relation(fields: [userId], references: [id])

  @@id([roomId, userId])
  @@index([userId])
}

model Category {
  id              String         @id @default(cuid())
  name            String
  image           String?
  nameTE          String?
  parentId        String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  attributeSchema Json?
  isActive        Boolean        @default(true)
  parent          Category?      @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        Category[]     @relation("CategoryHierarchy")
  specs               CategorySpec[]
  products            Product[]
  productSearchMisses ProductSearchMiss[]
  commissions         CategoryCommission[]

  @@index([parentId])
  @@index([isActive])
}

model GiftSKU {
  id                 String   @id @default(cuid())
  title              String
  stock              Int      @default(0)
  cost               Int      @default(0)
  eligibleCategories Json?
  createdAt          DateTime @default(now())
  orders             Order[]
}

model CoinLedger {
  id          String    @id @default(cuid())
  userId      String
  amount      Int
  source      String
  referenceId String?
  // ðŸ” Bow Coin Valuation Snapshot (future-only, audit-safe)
  // Stores the rupee valuation used at the time of this ledger entry.
  // Money is stored in integer paise; valuation is "paise per 1 coin".
  paisePerCoinAtTxn Int      @default(100)
  roleAtTxn         UserRole @default(CUSTOMER)
  expiresAt   DateTime?
  isExpired   Boolean   @default(false)  // ðŸ” P0 FIX: Preserve ledger history
  createdAt   DateTime  @default(now())
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([isExpired])  // For efficient expiry queries
  @@index([expiresAt])  // ðŸ” P0 FIX: Index for expiry cron job
  @@index([roleAtTxn, createdAt])
}

model Vendor {
  id               String            @id @default(cuid())
  name             String
  mobile           String            @unique
  email            String?
  pincode          String?           // For hyper-local sourcing
  latitude         Float?
  longitude        Float?
  kycStatus        String            @default("PENDING")
  tier             String            @default("BASIC")
  gstNumber        String?
  isGstVerified    Boolean           @default(false)
  kycDocuments     Json?
  skuLimit         Int               @default(100)
  role             VendorRole        @default(RETAILER)
  coinsBalance     Int               @default(0)
  followCount      Int               @default(0)
  vendorCode         String?           @unique
  commissionRate     Float             @default(0.0)
  commissionOverride Decimal?          @db.Decimal(5, 4) // e.g. 0.1250 for 12.5%
  createdAt          DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  strikes          Int               @default(0)
  storeName        String?
  storeLogo        String?
  storeBanner      String?
  storeTimings     Json?
  pickupEnabled    Boolean           @default(false)
  pickupTimings    Json?
  bankDetails      Json?
  lastPayoutDate   DateTime?
  pendingEarnings  Int               @default(0)
  performanceScore Float             @default(0.0)
  products         Product[]
  returns          ReturnRequest[]
  reviews          Review[]
  VendorFollower   VendorFollower[]
  VendorMembership VendorMembership?
  VendorPayout     VendorPayout[]
  VendorPromotion  VendorPromotion[]
  inquiriesReceived VendorInquiry[] @relation("VendorInquiryWholesaler")
  coupons          Coupon[]
  orderSettlements OrderSettlement[]

  @@index([kycStatus])
  @@index([tier])
  @@index([pincode])
}

model RoomPackage {
  id               String   @id @default(cuid())
  vendorId         String
  packageType      String
  remainingCredits Int
  createdAt        DateTime @default(now())
}

model Address {
  id           String   @id @default(cuid())
  userId       String
  title        String?
  name         String
  mobile       String?
  street       String?
  city         String
  state        String
  pincode      String
  isDefault    Boolean  @default(false)
  addressLine1 String   @default("")
  addressLine2 String?
  createdAt    DateTime @default(now())
  label        String   @default("Home")
  phone        String
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders       Order[]

  @@index([userId])
}

model Cart {
  id        String     @id @default(cuid())
  userId    String     @unique
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]

  @@index([userId])
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  variantId String?
  quantity  Int
  cart      Cart    @relation(fields: [cartId], references: [id])
  product   Product @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([cartId])
}

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, productId])
}

// B2B: Vendor inquiries to wholesalers for bulk purchase negotiation.
model VendorInquiry {
  id                String        @id @default(cuid())
  wholesalerVendorId String
  requesterUserId   String
  productId         String
  quantity          Int
  message           String?
  status            InquiryStatus @default(PENDING)
  response          String?
  respondedAt       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  wholesaler        Vendor        @relation("VendorInquiryWholesaler", fields: [wholesalerVendorId], references: [id], onDelete: Cascade)
  requester         User          @relation("VendorInquiryRequester", fields: [requesterUserId], references: [id], onDelete: Cascade)
  product           Product       @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([wholesalerVendorId, status])
  @@index([requesterUserId, status])
  @@index([productId])
  @@index([createdAt])
}

model Review {
  id           String   @id @default(cuid())
  userId       String
  productId    String?
  vendorId     String?
  rating       Int
  comment      String?
  images       String[]
  isVerified   Boolean  @default(false)
  status       String   @default("ACTIVE")
  helpfulCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product? @relation(fields: [productId], references: [id])
  user         User     @relation(fields: [userId], references: [id])
  vendor       Vendor?  @relation(fields: [vendorId], references: [id])

  @@index([productId])
  @@index([vendorId])
  @@index([userId])
  @@index([productId, status])
  @@index([vendorId, status])
}

model Payment {
  id              String        @id @default(cuid())
  orderId         String        @unique
  amount          Int
  currency        String        @default("INR")
  provider        String
  providerOrderId String?
  paymentId       String?
  status          PaymentStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  order           Order         @relation(fields: [orderId], references: [id])
}

// PaymentIntent for non-order payments (vendor monetization, memberships, etc.)
// Keeps order payments isolated in `Payment` to preserve invariants.
model PaymentIntent {
  id              String              @id @default(cuid())
  purpose         PaymentIntentPurpose
  referenceId     String
  amount          Int
  currency        String              @default("INR")
  provider        String              @default("RAZORPAY")
  providerOrderId String?
  paymentId       String?
  status          PaymentStatus       @default(PENDING)
  metadata        Json?
  createdByUserId String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  createdByUser   User?               @relation("PaymentIntentCreatedBy", fields: [createdByUserId], references: [id])

  @@unique([purpose, referenceId])
  @@index([status, createdAt])
  @@index([purpose, createdAt])
  @@index([createdByUserId, createdAt])
  @@index([providerOrderId])
}

model Banner {
  id          String   @id @default(cuid())
  vendorId    String?
  imageUrl    String
  redirectUrl String?
  slotType    String
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())

  @@index([vendorId])
  @@index([slotType, isActive])
  @@index([startDate, endDate])
  @@index([slotType, startDate, endDate, isActive])
}

model Notification {
  id             String   @id @default(cuid())
  userId         String?
  title          String
  body           String
  type           String
  targetAudience String?
  isRead         Boolean  @default(false)
  createdAt      DateTime @default(now())
  user           User?    @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([userId, createdAt])
}

model Order {
  id                  String             @id @default(cuid())
  userId              String
  roomId              String?
  addressId           String?
  items               Json
  totalAmount         Int
  coinsUsed           Int                @default(0)
  coinsUsedDebited    Boolean            @default(false)
  status              OrderStatus        @default(PENDING)
  razorpayOrderId     String?
  awbNumber           String?
  courierPartner      String?
  giftId              String?
  couponCode          String?
  obdOtp              String?            // OTP for Open-Box Delivery
  obdVerifiedAt       DateTime?
  discountAmount      Int                @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  abandonedCheckoutId String?
  agentId             String?
  shippingCharges     Int                @default(0)
  checkout            AbandonedCheckout? @relation(fields: [abandonedCheckoutId], references: [id])
  address             Address?           @relation(fields: [addressId], references: [id])
  user                User               @relation(fields: [userId], references: [id])
  payment             Payment?
  gift            GiftSKU?  @relation(fields: [giftId], references: [id])
  
  financialSnapshot OrderFinancialSnapshot?
  settlement        OrderSettlement?
  
  replacementParent  ReplacementOrder[] @relation("OriginalOrder")
  replacementChild   ReplacementOrder?  @relation("ReplacementOrder")
  
  deliveredAt     DateTime?
  returnWindow    Int       @default(7) // Days
  isReturnable    Boolean   @default(true)
  
  returns         ReturnRequest[]
  qcChecklist     ReturnQCChecklist?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([razorpayOrderId])
  @@index([awbNumber])
  @@index([userId, status])
  @@index([userId, status, createdAt])
  @@index([status, createdAt])
  @@index([roomId, userId])
}

model Product {
  id                   String             @id @default(cuid())
  vendorId             String
  title                String
  description          String?
  price                Int
  embedding            Json?              // Vector embedding for semantic search
  offerPrice           Int?
  stock                Int                @default(0)
  categoryId           String
  variants             ProductVariant[]
  images               String[]
  isWholesale          Boolean            @default(false)
  wholesalePrice       Int?
  moq                  Int                @default(1)
  isActive             Boolean            @default(false)
  visibility           ProductVisibility  @default(DRAFT)
  popularityScore      Float              @default(0)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  brandName            String?
  dimensionUnit        String?            @default("cm")
  height               Float?
  length               Float?
  metaDescription      String?
  metaKeywords         String[]
  metaTitle            String?
  shippingClass        String?
  sku                  String?            @unique
  tags                 String[]
  weight               Float?
  weightUnit           String?            @default("kg")
  width                Float?
  allergenInformation  String?
  attributes           Json?
  basePreparationTime  Int                @default(0)
  costPrice            Int?
  isAttachmentRequired Boolean            @default(false)
  isCancelable         Boolean            @default(false)
  isInclusiveTax       Boolean            @default(false)
  isReturnable         Boolean            @default(false)
  mediaGallery         Json?
  minOrderQuantity     Int                @default(1)
  quantityStepSize     Int                @default(1)
  requiresOTP          Boolean            @default(false)
  rulesSnapshot        Json?
  shippingDetails      Json?
  storageInstructions  String?
  totalAllowedQuantity Int                @default(10)
  rooms                Room[]
  freeListingExpiresAt DateTime?
  cartItems            CartItem[]
  category             Category           @relation(fields: [categoryId], references: [id])
  vendor               Vendor             @relation(fields: [vendorId], references: [id])
   specValues           ProductSpecValue[]
   returnItems          ReturnItem[]
   reviews              Review[]
   wishlists            Wishlist[]
   buyLater             BuyLater[]
   bowActionLogs        BowActionLog[]
   productEvents        UserProductEvent[]
   vendorInquiries      VendorInquiry[]

  @@index([vendorId])
  @@index([categoryId])
  @@index([isActive])
  @@index([sku])
  @@index([categoryId, isActive])
  @@index([vendorId, isActive])
  @@index([price])
  @@index([createdAt])
  @@index([categoryId, isActive, price])
  @@index([categoryId, isActive, createdAt])
  @@index([isActive, price])
  @@index([isActive, createdAt])
  @@index([vendorId, stock])
  @@index([vendorId, isActive, stock])
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      String
  createdAt DateTime @default(now())
}

model Report {
  id          String   @id @default(cuid())
  reporterId  String
  targetType  String
  targetId    String
  reason      String
  description String?
  status      String   @default("PENDING")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  reporter    User     @relation(fields: [reporterId], references: [id])

  @@index([status])
  @@index([targetType])
  @@index([reporterId])
}

model PlatformConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

// Bow Coin Valuation (admin-controlled, future-only).
// Append-only with effective dating. Service enforces "one active row per role".
model CoinValuation {
  id           String   @id @default(cuid())
  role         UserRole
  // integer paise per 1 coin (e.g., 100 => â‚¹1/coin, 10 => â‚¹0.10/coin)
  paisePerCoin Int
  effectiveFrom DateTime @default(now())
  effectiveTo   DateTime?
  // Nullable to allow bootstrapping in fresh environments before an admin user exists.
  // All admin-initiated changes must provide setByUserId and be audit logged.
  setByUserId   String?
  createdAt     DateTime @default(now())

  setByUser     User?    @relation("CoinValuationSetBy", fields: [setByUserId], references: [id])

  @@index([role, effectiveTo])
  @@index([role, effectiveFrom])
}

model Coupon {
  id             String    @id @default(cuid())
  code           String    @unique
  description    String?
  discountType   String
  discountValue  Int
  minOrderAmount Int?      @default(0)
  maxDiscount    Int?
  validFrom      DateTime  @default(now())
  validUntil     DateTime?
  usageLimit     Int?
  usedCount      Int       @default(0)
  isActive       Boolean   @default(true)
  vendorId       String?
  productIds     String[]
  categoryIds    String[]
  minQuantity    Int?
  vendor         Vendor?   @relation(fields: [vendorId], references: [id])
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([vendorId])
  @@index([isActive])
}

model AdminNote {
  id        String   @id @default(cuid())
  userId    String
  adminId   String
  note      String
  createdAt DateTime @default(now())
  admin     User     @relation("AdminAuthor", fields: [adminId], references: [id])
  user      User     @relation("UserNotes", fields: [userId], references: [id])
}

model AbandonedCheckout {
  id              String                 @id @default(cuid())
  userId          String?
  guestInfo       Json?
  cartSnapshot    Json
  financeSnapshot Json
  metadata        Json?
  status          CheckoutRecoveryStatus @default(NEW)
  abandonReason   String?   // PAYMENT_FAILED, USER_BACK, TIMEOUT
  paymentMethod   String?   // UPI, CARD, COD
  lastErrorCode   String?
  agentId         String?
  lockedUntil     DateTime?
  createdAt       DateTime               @default(now())
  abandonedAt     DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  agent           User?                  @relation("AgentCheckouts", fields: [agentId], references: [id])
  user            User?                  @relation(fields: [userId], references: [id])
  followups       CheckoutFollowup[]
  orders          Order[]

  @@index([status])
  @@index([agentId])
  @@index([abandonedAt])
  @@index([status, agentId])
}

model CheckoutFollowup {
  id         String            @id @default(cuid())
  checkoutId String
  agentId    String
  note       String
  outcome    CallOutcome?
  createdAt  DateTime          @default(now())
  agent      User              @relation(fields: [agentId], references: [id])
  checkout   AbandonedCheckout @relation(fields: [checkoutId], references: [id])
}



// --- RETURNS SYSTEM ---

enum ReturnStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
  PICKUP_SCHEDULED
  PICKUP_COMPLETED
  IN_TRANSIT
  RECEIVED_AT_WAREHOUSE
  QC_IN_PROGRESS
  QC_PASSED
  QC_FAILED
  REFUND_INITIATED
  REFUND_COMPLETED
  REPLACEMENT_INITIATED
  REPLACEMENT_SHIPPED
  REPLACEMENT_COMPLETED
  CANCELLED
}

enum ReturnReason {
  DAMAGED_PRODUCT
  WRONG_ITEM
  MISSING_PARTS
  QUALITY_ISSUE
  SIZE_FIT_ISSUE
  NOT_AS_DESCRIBED
  DEFECTIVE
  CHANGED_MIND
  OTHER
}

enum ItemCondition {
  UNOPENED
  OPENED_UNUSED
  USED_LIKE_NEW
  USED_GOOD
  USED_FAIR
  DAMAGED
  DEFECTIVE
}

enum CostBearer {
  PLATFORM
  VENDOR
  CUSTOMER
  SHARED
}




model ReturnRequest {
  id                     String            @id @default(cuid())
  returnNumber           String            @unique // RET-{timestamp}-{orderIdShort}
  orderId                String
  userId                 String
  vendorId               String?
  status                 ReturnStatus      @default(PENDING_APPROVAL)
  reason                 ReturnReason
  description            String?
  evidenceImages         String[]
  evidenceVideo          String?
  
  requestedAt            DateTime          @default(now())
  approvedAt             DateTime?
  rejectedAt             DateTime?
  completedAt            DateTime?
  updatedAt              DateTime          @updatedAt
  
  pickupDate             DateTime?
  pickupAddress          Json?
  courierPartner         String?
  trackingId             String?
  replacementTrackingId  String?
  
  qcNotes                String?
  qcBy                   String?
  
  order                  Order             @relation(fields: [orderId], references: [id])
  user                   User              @relation(fields: [userId], references: [id])
  vendor                 Vendor?           @relation(fields: [vendorId], references: [id])
  items                  ReturnItem[]
  settlement             ReturnSettlement?
  timeline               ReturnTimeline[]
  replacement            ReplacementOrder?
  
  @@index([orderId])
  @@index([status])
  @@index([userId])
  @@index([vendorId])
  @@index([returnNumber])
}

model ReturnItem {
  id            String        @id @default(cuid())
  returnId      String
  productId     String
  variantId     String?
  quantity      Int
  reason        ReturnReason?
  description   String?
  condition     String?
  
  qcStatus      ItemCondition?
  qcNotes       String?
  
  returnRequest ReturnRequest @relation(fields: [returnId], references: [id])
  product       Product       @relation(fields: [productId], references: [id])

  @@index([returnId])
  @@index([productId])
}

model ReturnSettlement {
  id             String        @id @default(cuid())
  returnId       String        @unique
  costBearer     CostBearer    @default(PLATFORM)
  penaltyAmount  Int           @default(0) // In paise
  penaltyReason  String?
  penaltyApplied Boolean       @default(false)
  adminNotes     String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  returnRequest  ReturnRequest @relation(fields: [returnId], references: [id])
}

model ReturnTimeline {
  id            String        @id @default(cuid())
  returnId      String
  status        ReturnStatus
  action        String
  performedBy   String        // CUSTOMER, ADMIN, VENDOR, SYSTEM
  actorId       String?       // ID of the person performing action
  notes         String?
  metadata      Json?
  timestamp     DateTime      @default(now())
  
  returnRequest ReturnRequest @relation(fields: [returnId], references: [id])
  
  @@index([returnId])
  @@index([timestamp])
}

// CRITICAL: OrderFinancialSnapshot is IMMUTABLE after order confirmation.
// This snapshot captures the financial state at checkout time and must NEVER be modified
// once the order status moves beyond PENDING. This ensures financial integrity and audit compliance.
// Application-level protection is enforced via FinancialSnapshotGuardService.
// Database-level enforcement: Updates are prevented by checking order.status before allowing modifications.
model OrderFinancialSnapshot {
  id                String   @id @default(cuid())
  orderId           String   @unique

  subtotal          Int
  taxAmount         Int
  shippingAmount    Int
  discountAmount    Int
  giftCost          Int

  commissionRate    Float
  commissionAmount  Int
  vendorEarnings    Int
  platformEarnings  Int

  currency          String   @default("INR")
  calculatedAt      DateTime @default(now())

  order             Order    @relation(fields: [orderId], references: [id])

  @@index([orderId])
}

model OrderSettlement {
  id          String           @id @default(cuid())
  orderId     String           @unique
  vendorId    String
  amount      Int
  status      SettlementStatus @default(PENDING)
  eligibleAt  DateTime?
  settledAt   DateTime?
  createdAt  DateTime          @default(now())

  order       Order            @relation(fields: [orderId], references: [id])
  vendor      Vendor           @relation(fields: [vendorId], references: [id])

  @@index([vendorId, status])
}

model CategoryCommission {
  id            String   @id @default(cuid())
  categoryId    String
  commissionRate Float
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())

  category      Category @relation(fields: [categoryId], references: [id])

  @@unique([categoryId])
}

model ReplacementOrder {
  id              String   @id @default(cuid())
  originalOrderId String
  returnId        String   @unique
  newOrderId      String   @unique
  createdAt       DateTime @default(now())

  originalOrder   Order    @relation("OriginalOrder", fields: [originalOrderId], references: [id])
  newOrder        Order    @relation("ReplacementOrder", fields: [newOrderId], references: [id])
  returnRequest   ReturnRequest @relation(fields: [returnId], references: [id])
}

model SearchClick {
  id        String   @id @default(cuid())
  query     String
  productId String
  userId    String?
  clickedAt DateTime @default(now())

  @@index([query])
  @@index([productId])
}

model TelecallerPerformance {
  id           String   @id @default(cuid())
  agentId      String
  date         DateTime
  assigned     Int      @default(0)
  contacted    Int      @default(0)
  converted    Int      @default(0)
  dropped      Int      @default(0)

  agent        User     @relation(fields: [agentId], references: [id])

  @@unique([agentId, date])
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  sku       String?  @unique
  attributes Json
  price     Int?
  stock     Int      @default(0)
  status    VariationStatus @default(ACTIVE)

  product   Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([stock])
}

model AuditLog {

  id        String   @id @default(cuid())
  adminId   String
  entity    String
  action    String
  details   Json?
  createdAt DateTime @default(now())
  entityId  String
  ipAddress String?
  userAgent String?
  admin     User     @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([entity])
  @@index([action])
  @@index([createdAt])
}


model CategorySpec {
  id            String             @id @default(cuid())
  categoryId    String
  key           String
  label         String
  labelTE       String?
  type          SpecType
  unit          String?
  required      Boolean            @default(false)
  options       Json?
  sortOrder     Int                @default(0)
  isActive      Boolean            @default(true)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  category      Category           @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  productValues ProductSpecValue[]

  @@unique([categoryId, key])
  @@index([categoryId, isActive])
  @@index([categoryId, sortOrder])
}

model ProductSpecValue {
  id        String       @id @default(cuid())
  productId String
  specId    String
  value     String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  product   Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  spec      CategorySpec @relation(fields: [specId], references: [id], onDelete: Cascade)

  @@unique([productId, specId])
  @@index([productId])
  @@index([specId])
}

model BowInteraction {
  id            String        @id @default(cuid())
  userId        String
  sessionId     String
  type          InteractionType
  query         String?
  response      String?
  intent        String?       // ADD_TO_CART, etc.
  confidence    Float?        // 0.0 to 1.0
  actionType    BowActionType?
  actionPayload Json?
  metadata      Json?
  context       Json?
  sentiment     String?
  conversionEvent String?       // ADD_TO_CART, CHECKOUT_STARTED, ORDER_PLACED
  conversionValue Int?          // Value attributed to this interaction
  escalated     Boolean       @default(false)
  createdAt     DateTime      @default(now())
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([escalated])
  @@index([sessionId])
  @@index([userId])
  @@index([sessionId, createdAt])
}

enum CartInsightType {
  HESITATION
  THRESHOLD_NEAR
  BUNDLE_OPPORTUNITY
  PRICE_SENSITIVITY
  REPEAT_REMOVAL
  GIFT_ELIGIBLE
}

enum InsightSeverity {
  LOW
  MEDIUM
  HIGH
}

enum BowActionType {
  ADD_TO_CART
  REMOVE_FROM_CART
  UPDATE_QUANTITY
  APPLY_COUPON
  SELECT_GIFT
  NAVIGATE
  VIEW_CART
  GET_RECOMMENDATIONS
  CLIENT_CONTROL
  ROOM_NUDGE
  SUGGEST_BUNDLE
  SUGGEST_GIFT
  SUGGEST_UPSELL
  REMOVE_SUGGESTION
}

model ReferralTracking {
  id                String         @id @default(cuid())
  referrerId        String
  refereeId         String
  referralCode      String
  status            ReferralStatus @default(PENDING)
  coinsAwarded      Int            @default(0)
  firstOrderId      String?
  deviceFingerprint String?
  ipAddress         String?
  createdAt         DateTime       @default(now())
  completedAt       DateTime?
  referee           User           @relation("ReferralTracking_refereeIdToUser", fields: [refereeId], references: [id], onDelete: Cascade)
  referrer          User           @relation("ReferralTracking_referrerIdToUser", fields: [referrerId], references: [id], onDelete: Cascade)

  @@index([refereeId])
  @@index([referralCode])
  @@index([referrerId])
  @@index([status])
}

model VendorFollower {
  vendorId  String
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@id([vendorId, userId])
  @@index([userId])
  @@index([vendorId])
}

model VendorMembership {
  id             String         @id @default(cuid())
  vendorId       String         @unique
  tier           MembershipTier @default(FREE)
  price          Int            @default(0)
  skuLimit       Int            @default(10)
  imageLimit     Int            @default(3)
  commissionRate Float          @default(0.15)
  payoutCycle    PayoutCycle    @default(MONTHLY)
  features       Json?
  startDate      DateTime       @default(now())
  endDate        DateTime?
  isActive       Boolean        @default(true)
  autoRenew      Boolean        @default(false)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  vendor         Vendor         @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([tier])
  @@index([vendorId])
}

model VendorPayout {
  id            String       @id @default(cuid())
  vendorId      String
  amount        Int
  period        String
  status        PayoutStatus @default(PENDING)
  bankDetails   Json
  transactionId String?
  processedAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  vendor        Vendor       @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([vendorId])
}

model VendorPromotion {
  id          String          @id @default(cuid())
  vendorId    String
  type        PromotionType
  packageType String?
  productIds  String[]
  startDate   DateTime
  endDate     DateTime
  coinsCost   Int             @default(0)
  moneyCost   Int?
  status      PromotionStatus @default(ACTIVE)
  metadata    Json?
  impressions Int             @default(0)
  clicks      Int             @default(0)
  orders      Int             @default(0)
  revenue     Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  vendor      Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([startDate, endDate])
  @@index([status])
  @@index([type])
  @@index([vendorId])
  @@index([vendorId, status])
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING
  BANNED
}

enum UserRole {
  CUSTOMER
  VENDOR
  WHOLESALER
  ADMIN
  SUPER_ADMIN
  TELECALLER
}

enum RoomStatus {
  LOCKED
  ACTIVE
  UNLOCKED
  EXPIRED
  OPEN      // Phase 3.1: Accepts members
  COMPLETED // Phase 3.1: Purchase successful
}

enum RoomType {
  GOAL_BASED      // Phase 2
  LINEAR_DISCOUNT // Phase 3.1
}

enum MemberStatus {
  PENDING
  ORDERED
  CONFIRMED
  CANCELLED
}

enum RoomBoostType {
  PRIORITY_VISIBILITY
  UNLOCK_ACCELERATOR
  SPONSORED_PRODUCT
}

enum OrderStatus {
  CREATED
  PENDING
  PENDING_PAYMENT
  CONFIRMED
  PAID
  PACKED
  SHIPPED
  OUT_FOR_INSPECTION
  DELIVERED
  CANCELLED
  RETURN_REQUESTED
  QC_IN_PROGRESS
  RETURN_PICKED_UP
  RETURN_RECEIVED
  RETURNED
  REFUNDED
}

enum VendorRole {
  RETAILER
  WHOLESALER
}

enum ReviewStatus {
  ACTIVE
  REPORTED
  HIDDEN
  DELETED
  PENDING
  APPROVED
  REJECTED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentIntentPurpose {
  BANNER_SLOT
  ROOM_PROMOTION
  VENDOR_MEMBERSHIP
}

enum InquiryStatus {
  PENDING
  RESPONDED
  ACCEPTED
  REJECTED
  EXPIRED
}

enum UserProductEventType {
  PRODUCT_VIEW
  PRODUCT_CLICK
  ADD_TO_CART
  REMOVE_FROM_CART
  WISHLIST_ADD
  PURCHASE
}

enum RiskTag {
  LOW
  MEDIUM
  HIGH
}

enum ValueTag {
  NORMAL
  VIP
}

enum CheckoutRecoveryStatus {
  NEW
  ASSIGNED
  FOLLOW_UP
  CONVERTED
  DROPPED
}

enum CallOutcome {
  NOT_REACHABLE
  FOLLOW_UP_SCHEDULED
  CONVERTED
  DROPPED
  WRONG_NUMBER
}


enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
  FAILED
}

enum RefundMethod {
  ORIGINAL_PAYMENT
  COINS
  BANK_TRANSFER
}

enum AttributeScope {
  PRODUCT
  VARIATION
}

enum ProductVisibility {
  DRAFT
  PUBLISHED
  BLOCKED
}

enum VariationStatus {
  ACTIVE
  OUT_OF_STOCK
  ARCHIVED
}

enum MediaType {
  IMAGE
  VIDEO
  GIF
}

enum VendorStatus {
  ACTIVE
  SUSPENDED
}

enum SpecType {
  TEXT
  NUMBER
  SELECT
  BOOLEAN
  MULTISELECT
}

enum MembershipTier {
  FREE
  BASIC
  PRO
  PREMIUM
  ELITE
}

enum PayoutCycle {
  WEEKLY
  BIWEEKLY
  MONTHLY
  INSTANT
}

enum PromotionType {
  BANNER
  ROOM_PACKAGE
  FEATURED
}

enum PromotionStatus {
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum InteractionType {
  CHAT
  VOICE
  RECOMMENDATION
  ACTION
}

enum ReferralStatus {
  PENDING
  COMPLETED
  EXPIRED
}

// --- BETTING SYSTEM MODELS ---

enum BetStatus {
  PENDING
  PLACED
  SETTLED_WIN
  SETTLED_LOSE
  CANCELLED
  VOIDED
}

enum BetType {
  SINGLE
  MULTIPLE
  SYSTEM
}

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  balance   Int      @default(0) // In paise
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])
  ledger    LedgerEntry[]

  @@index([userId])
}

model BuyLater {
  id                String    @id @default(cuid())
  userId            String
  productId         String
  variantId         String?   // For product variants
  targetPrice       Int       // Target price in paise
  currentPrice      Int       // Price when added to buy later
  quantity          Int       @default(1)
  isActive          Boolean   @default(true)
  isNotified        Boolean   @default(false)  // Track if user was notified
  isAddedToCart    Boolean   @default(false)  // Track if added to cart
  priceDropPercent  Float?    // Percentage of price drop when notified
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  user              User      @relation(fields: [userId], references: [id])
  product          Product   @relation(fields: [productId], references: [id])
  
  @@index([userId])
  @@index([productId])
  @@index([isActive])
  @@index([isNotified])
  @@index([createdAt])
}

model Bet {
  id             String    @id @default(cuid())
  userId         String
  idempotencyKey String    @unique
  type           BetType   @default(SINGLE)
  selections     Json      // Bet selections
  stake          Int       // In paise
  odds           Float
  potentialWin   Int       // Calculated payout
  status         BetStatus @default(PENDING)
  placedAt       DateTime  @default(now())
  settledAt      DateTime?
  result         String?   // WIN, LOSE, VOID
  payout         Int?      // Actual payout amount
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id])
  ledgerEntries  LedgerEntry[]

  @@index([userId])
  @@index([status])
  @@index([idempotencyKey])
}

model LedgerEntry {
  id          String   @id @default(cuid())
  userId      String
  walletId    String
  betId       String?
  amount      Int      // Positive for credit, negative for debit
  type        String   // BET_PLACEMENT, BET_WIN, BET_LOSE, DEPOSIT, WITHDRAWAL
  description String
  balanceAfter Int     // Wallet balance after this entry
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id])
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  bet         Bet?     @relation(fields: [betId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([walletId])
  @@index([betId])
  @@index([createdAt])
}

// B2B/B2C High-Trust Features: QC Return Protocol
model ReturnQCChecklist {
  id          String   @id @default(cuid())
  orderId     String   @unique
  inspectorId String   // Telecaller/Agent ID
  status      Boolean  @default(false)
  
  // Inspection Items (Checklist)
  isOriginalPackaging Boolean @default(false)
  isUnused            Boolean @default(false)
  allAccessoriesPresent Boolean @default(false)
  hasPhysicalDamage   Boolean @default(false)
  imeiMatch           Boolean @default(true)
  
  photos      String[] 
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  order       Order    @relation(fields: [orderId], references: [id])
}

